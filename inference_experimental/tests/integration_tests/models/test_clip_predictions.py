import os
from typing import Generator, Tuple

import numpy as np
import pytest
import torch
import torch.nn.functional as F
from clip import clip
from filelock import FileLock
from inference_exp.configuration import DEFAULT_DEVICE
from PIL.Image import Image
from torch import nn

EXPECTED_DOG_IMAGE_EMBEDDING = torch.tensor(
    [
        [
            -0.031097251921892166,
            0.022592462599277496,
            -0.04396592453122139,
            -0.0007368356455117464,
            0.07483792304992676,
            -0.014669923111796379,
            -0.06318386644124985,
            -0.011936116963624954,
            -0.0059200553223490715,
            -0.10771632194519043,
            0.030868932604789734,
            -0.053155720233917236,
            0.005249695852398872,
            -0.061359040439128876,
            -0.03870873525738716,
            -0.03505817800760269,
            0.0013327505439519882,
            -0.009472834877669811,
            -0.003691209712997079,
            0.011363357305526733,
            -0.016771361231803894,
            -0.04830535128712654,
            -0.012435127049684525,
            -0.03466420993208885,
            0.0440685898065567,
            -0.014810960739850998,
            -0.061507247388362885,
            -0.03315342962741852,
            0.025561094284057617,
            -0.009816307574510574,
            0.011139423586428165,
            0.02264007367193699,
            -0.024608686566352844,
            -0.02294469252228737,
            -0.052961863577365875,
            0.0446794331073761,
            -0.03043195977807045,
            -0.02882559970021248,
            0.028642814606428146,
            -0.01757318340241909,
            0.04256169870495796,
            -0.05999220162630081,
            -0.04403282701969147,
            -0.0022346172481775284,
            0.013565640896558762,
            0.018540527671575546,
            0.0035448598209768534,
            0.02599646896123886,
            0.11427465081214905,
            0.003773867152631283,
            -0.0023760609328746796,
            0.05056052282452583,
            -0.06617005169391632,
            -0.06291771680116653,
            -0.05429662764072418,
            -0.193481907248497,
            -0.0027031823992729187,
            -0.005666401237249374,
            0.024924689903855324,
            0.010380322113633156,
            -0.03802142292261124,
            -0.005807694047689438,
            -0.017887093126773834,
            0.05517300218343735,
            -0.007923765107989311,
            -0.0018998542800545692,
            -0.0014354144223034382,
            0.07351212948560715,
            -0.04035119712352753,
            0.012874869629740715,
            -0.03339091315865517,
            -0.027264349162578583,
            -0.009416814893484116,
            -0.0037184078246355057,
            -0.0318426676094532,
            0.0017665475606918335,
            -0.0037836777046322823,
            -0.0071710143238306046,
            0.037627171725034714,
            -0.037627458572387695,
            0.0366431325674057,
            -0.02522304281592369,
            -0.05386998504400253,
            0.06263898313045502,
            -0.023601291701197624,
            -0.04260632395744324,
            0.17217379808425903,
            -0.028521385043859482,
            0.003934044390916824,
            0.007718678563833237,
            0.015264470130205154,
            -0.014377184212207794,
            0.03925257548689842,
            -0.11194613575935364,
            -0.016236696392297745,
            -0.019648905843496323,
            -0.016207881271839142,
            -0.03374052420258522,
            -0.01498030498623848,
            -0.04500759020447731,
            0.0044603971764445305,
            -0.10959628969430923,
            0.022264275699853897,
            -0.018034378066658974,
            -0.02135574445128441,
            0.02165086194872856,
            0.07172238081693649,
            0.008917799219489098,
            -0.05626579001545906,
            0.10263039171695709,
            0.022014731541275978,
            0.10097366571426392,
            0.015948444604873657,
            0.030626457184553146,
            0.02199406921863556,
            -0.0011415635235607624,
            0.06894735991954803,
            0.011019548401236534,
            -0.034834519028663635,
            0.014232508838176727,
            -0.0044865794479846954,
            -0.062181465327739716,
            -0.0018282346427440643,
            -0.04188373684883118,
            0.05475950241088867,
            0.026832688599824905,
            -0.0003554057329893112,
            -0.05916610732674599,
            0.030002746731042862,
            0.01902136392891407,
            -0.01246881764382124,
            0.04893586039543152,
            0.045032717287540436,
            -0.020867135375738144,
            0.00937695987522602,
            -0.025870008394122124,
            -0.006083078682422638,
            0.03795512393116951,
            -0.04340742528438568,
            0.019756704568862915,
            0.0635136216878891,
            -0.016004469245672226,
            -0.015212563797831535,
            0.005825744941830635,
            -0.11820341646671295,
            -0.01133701391518116,
            -0.00014230050146579742,
            0.04836191609501839,
            -0.0029564984142780304,
            -0.019103944301605225,
            -0.02308216504752636,
            -0.009142317809164524,
            0.05122453719377518,
            0.06398820877075195,
            -0.01071932166814804,
            0.033157069236040115,
            -0.04367297887802124,
            0.010129733942449093,
            0.0003480148734524846,
            0.0021202480420470238,
            -0.014929316937923431,
            -0.03461281210184097,
            0.04667405039072037,
            -0.018380556255578995,
            -0.042687661945819855,
            0.011182794347405434,
            -0.07415159046649933,
            0.017722710967063904,
            -0.006772796623408794,
            -0.0878119170665741,
            0.05297449231147766,
            -0.006262252107262611,
            -0.017891723662614822,
            0.027253475040197372,
            -0.015911301597952843,
            0.022157132625579834,
            -0.014653373509645462,
            -0.05307978391647339,
            0.02682291716337204,
            -0.0032836284954100847,
            -0.038994673639535904,
            0.03127608820796013,
            0.0021743816323578358,
            0.002574428915977478,
            -0.006119959056377411,
            0.04694897681474686,
            0.0017188135534524918,
            -0.025172170251607895,
            0.031240977346897125,
            -0.005239993333816528,
            0.032406195998191833,
            0.0252239853143692,
            0.09107878804206848,
            -0.011592759750783443,
            0.07519577443599701,
            0.002043522894382477,
            -0.038017578423023224,
            -0.002837148495018482,
            -0.035013146698474884,
            0.0032918015494942665,
            1.9333558157086372e-05,
            0.004769191145896912,
            -0.2162550389766693,
            0.04136884957551956,
            -0.024497658014297485,
            0.0021324907429516315,
            0.020363494753837585,
            0.0026840372011065483,
            0.07808592915534973,
            0.00164084043353796,
            0.0147616658359766,
            -0.06829085946083069,
            -0.0006220415234565735,
            -0.024198856204748154,
            0.01682913675904274,
            0.023754499852657318,
            0.211904376745224,
            0.010954329743981361,
            -0.012673679739236832,
            -0.004485364072024822,
            0.0036636781878769398,
            0.01384536363184452,
            -0.25001487135887146,
            0.009204087778925896,
            -0.08500497043132782,
            -0.024687163531780243,
            0.039638496935367584,
            -0.0758475810289383,
            0.03542284667491913,
            0.0014221565797924995,
            0.00585806742310524,
            -0.0042518433183431625,
            0.012569962069392204,
            -0.05578615516424179,
            -0.013670435175299644,
            0.06292501091957092,
            0.035093843936920166,
            -0.021278033033013344,
            -0.00840939860790968,
            0.01651044189929962,
            -0.017899930477142334,
            0.052002377808094025,
            0.06599241495132446,
            -0.027905726805329323,
            -0.007202138192951679,
            0.02821950986981392,
            0.022091900929808617,
            -0.09273979812860489,
            0.017080634832382202,
            -0.004210985265672207,
            -0.0025479253381490707,
            0.013904460705816746,
            -0.026943568140268326,
            0.0014518406242132187,
            -0.019391942769289017,
            0.021574847400188446,
            -0.1721983551979065,
            0.026290446519851685,
            0.037041615694761276,
            0.03791528195142746,
            0.021839488297700882,
            0.028662461787462234,
            -0.03924066573381424,
            0.01994764804840088,
            -0.07312285900115967,
            -0.021507572382688522,
            -0.042778924107551575,
            0.2552146911621094,
            -0.00515822833403945,
            0.07041741907596588,
            0.019978415220975876,
            -0.08665941655635834,
            0.030094370245933533,
            0.28329840302467346,
            0.019981009885668755,
            -0.0350661426782608,
            0.013104254379868507,
            -0.013245699927210808,
            0.06422726064920425,
            0.03399088978767395,
            -0.03155122697353363,
            0.20477180182933807,
            0.0045036859810352325,
            -0.010686790570616722,
            -0.027966413646936417,
            0.029852192848920822,
            0.013353817164897919,
            -0.08694066107273102,
            0.03566795587539673,
            0.017478983849287033,
            0.014283910393714905,
            -0.0489521324634552,
            0.002932193223387003,
            -0.013638843782246113,
            0.06990986317396164,
            0.03733508661389351,
            0.02060442976653576,
            0.03434455022215843,
            0.11320136487483978,
            0.06885222345590591,
            0.30648863315582275,
            -0.07207290828227997,
            0.02653489261865616,
            0.0577603280544281,
            0.04246851056814194,
            0.00979454442858696,
            0.007919352501630783,
            -0.024656936526298523,
            0.013212667778134346,
            0.007052924484014511,
            0.03650796413421631,
            -0.014111019670963287,
            -0.032520074397325516,
            -0.008540855720639229,
            0.03618093580007553,
            0.0028659901581704617,
            -0.05883556604385376,
            -0.034689679741859436,
            -0.08623017370700836,
            0.022138450294733047,
            0.0439407117664814,
            -0.024237757548689842,
            -0.014896970242261887,
            -0.008287036791443825,
            0.00563333835452795,
            0.11953721940517426,
            -0.007144935429096222,
            -0.07264381647109985,
            0.042067162692546844,
            -0.029766760766506195,
            0.03957682102918625,
            -0.01939559541642666,
            0.0009639845229685307,
            -0.2232690155506134,
            0.02316085621714592,
            -0.005594880320131779,
            -0.008199905976653099,
            0.034620095044374466,
            -0.029718272387981415,
            0.05241929367184639,
            0.019716225564479828,
            0.09064191579818726,
            9.740935638546944e-05,
            0.046610310673713684,
            -0.004374109208583832,
            0.002139277756214142,
            -0.010551877319812775,
            -0.02034647762775421,
            -0.0001902170479297638,
            -0.0029340488836169243,
            0.0013845665380358696,
            0.0650654211640358,
            -0.09621088951826096,
            -0.09003043174743652,
            -0.06882689148187637,
            0.02149941772222519,
            0.002375347539782524,
            0.03735770285129547,
            -0.01864207535982132,
            -0.0008496660739183426,
            0.010613497346639633,
            0.0935295820236206,
            0.025271954014897346,
            -0.005375800654292107,
            -0.014589397236704826,
            0.0018813153728842735,
            0.05290094017982483,
            -0.02521505579352379,
            0.00044210441410541534,
            -0.006950461305677891,
            -0.014700855128467083,
            -0.0030920710414648056,
            0.018974492326378822,
            -0.030709270387887955,
            0.08245354145765305,
            -0.029941588640213013,
            0.04648829624056816,
            -0.046196844428777695,
            0.0028851404786109924,
            0.061643268913030624,
            -0.1443818211555481,
            0.29377228021621704,
            0.0024768528528511524,
            -0.03143562749028206,
            0.006347177550196648,
            -0.0240282341837883,
            0.012497156858444214,
            -0.02384253963828087,
            -0.06988823413848877,
            -0.006164759397506714,
            0.010143810883164406,
            -0.027400700375437737,
            0.011864112690091133,
            0.00460946187376976,
            -0.0009490633383393288,
            0.00786721520125866,
            -0.08419856429100037,
            -0.010809818282723427,
            -0.039862725883722305,
            0.004795528948307037,
            0.014800144359469414,
            0.0005853234324604273,
            0.095869280397892,
            0.001200597733259201,
            -0.032551754266023636,
            0.03339293226599693,
            -0.007209669798612595,
            0.01634543016552925,
            0.043648507446050644,
            -0.09138385951519012,
            0.01809309795498848,
            -0.08192451298236847,
            -0.001989020500332117,
            0.03789333626627922,
            0.031986430287361145,
            -0.005568280816078186,
            -0.021739039570093155,
            -0.035001859068870544,
            -0.01105046458542347,
            -0.03178395703434944,
            -0.06931568682193756,
            -0.01018644217401743,
            0.011605869978666306,
            -0.03726734220981598,
            -0.008644788525998592,
            0.02821967750787735,
            0.0009067952632904053,
            -0.07661160826683044,
            -0.004289112985134125,
            -0.011114056222140789,
            -0.023378610610961914,
            -0.0398981012403965,
            0.11205713450908661,
            -0.03703012317419052,
            -0.03458134084939957,
            0.018862847238779068,
            0.03515376150608063,
            -0.015087399631738663,
            0.012577913701534271,
            -0.03164872154593468,
            0.021940603852272034,
            0.00990484282374382,
            -0.045557983219623566,
            -0.011504985392093658,
            -0.008347781375050545,
            -0.019535237923264503,
            -0.01868029311299324,
            -0.009710930287837982,
            0.009657373651862144,
            0.041298553347587585,
            0.1090313121676445,
            0.048222336918115616,
            0.03355149179697037,
            0.021768618375062943,
            -0.04881701618432999,
            0.022713828831911087,
            0.020240582525730133,
            0.0157378688454628,
            -0.005680231377482414,
            -0.03775659203529358,
            -0.021720239892601967,
            -0.09326629340648651,
            0.005506737157702446,
            0.0015054233372211456,
            -0.06246381253004074,
            0.010555727407336235,
            -0.048256777226924896,
            -0.04891900718212128,
            -0.017880452796816826,
            0.009697359055280685,
            0.018435316160321236,
            0.02393760159611702,
            -0.086220882833004,
            0.03385567665100098,
            0.0161970816552639,
            0.051260143518447876,
            0.05985070392489433,
            -0.033033378422260284,
            -0.04634939506649971,
            0.0059188054874539375,
            -0.02202104777097702,
            0.02403947524726391,
            0.1673564314842224,
            0.022030986845493317,
            0.006549394689500332,
            0.0005707740783691406,
            -0.03726097568869591,
            0.07447245717048645,
            0.010527082718908787,
            0.008901562541723251,
            0.02840273082256317,
            -0.019240770488977432,
            0.028544634580612183,
            0.012673325836658478,
            0.008335588499903679,
            -0.023727893829345703,
            -0.013662219047546387,
            -0.06601660698652267,
            0.023623637855052948,
            -0.010973585769534111,
            0.013211177662014961,
            -0.033334143459796906,
            0.001845411490648985,
            -0.007923436351120472,
            -0.0030097393319010735,
            0.002910088747739792,
            0.0065383948385715485,
            0.06585098057985306,
            -0.04204227402806282,
            0.05161675438284874,
            0.10621966421604156,
            0.00960642658174038,
            -0.24090620875358582,
            0.0022071367129683495,
            -0.041290149092674255,
            -0.05521727353334427,
            -0.05078313499689102,
            -0.012852983549237251,
            0.016922147944569588,
            -0.023894432932138443,
            0.007125691045075655,
            0.3642425537109375,
            -0.019835898652672768,
            0.012307657860219479,
            -0.012459799647331238,
            -0.001591886393725872,
            -0.9392609596252441,
            0.041414715349674225,
            0.009920388460159302,
            0.03403680771589279,
            -0.054376378655433655,
            -0.04077950865030289,
            -0.00309760682284832,
            0.014475220814347267,
            0.041887179017066956,
            0.008537406101822853,
            0.002468650694936514,
            0.039087213575839996,
            -0.00598689541220665,
            -0.016274750232696533,
            -0.038829781115055084,
            0.031590692698955536,
            -0.06158427521586418,
            -0.0853058397769928,
            0.01824399083852768,
            0.0004228625912219286,
            -0.016728557646274567,
            0.010318383574485779,
            -0.005985370371490717,
            0.0382629930973053,
            -0.002621234394609928,
            -0.025848932564258575,
            0.021590828895568848,
            0.02933124080300331,
            -0.012990531511604786,
            0.016343366354703903,
            0.11914855241775513,
            0.03217720612883568,
            0.039510779082775116,
            -0.033485881984233856,
            0.027359750121831894,
            -0.006031740456819534,
            -0.006334514357149601,
            0.00880882516503334,
            -0.04095204174518585,
            -0.052830372005701065,
            -0.01563551463186741,
            0.009864447638392448,
            0.000887368805706501,
            -0.022072292864322662,
            -0.0021340218372642994,
            -0.03724534064531326,
            0.0016753645613789558,
            -0.017585881054401398,
            -0.03408649563789368,
            -0.10503040254116058,
            -0.011093854904174805,
            0.049207232892513275,
            -0.005274545401334763,
            -0.011508893221616745,
            -0.02294279634952545,
            0.025267038494348526,
            0.03349664434790611,
            0.023123135790228844,
            -0.05085920915007591,
            -0.027524098753929138,
            0.07166805118322372,
            -0.05908882990479469,
            0.0531291738152504,
            0.03883889317512512,
            0.00831041019409895,
            -0.00551715400069952,
            0.014138562604784966,
            0.0028109829872846603,
            0.029045794159173965,
            0.022375311702489853,
            0.033453408628702164,
            -0.0025163106620311737,
            -0.06301427632570267,
            0.10971298813819885,
            0.00858672708272934,
            0.19507426023483276,
            0.005405501928180456,
            0.032567717134952545,
            0.027866210788488388,
            -0.00875302404165268,
            -0.004161307588219643,
            0.02657213807106018,
            -0.06832967698574066,
            -0.12282361090183258,
            -0.11664484441280365,
            0.003398069180548191,
            -0.0010440684854984283,
            -0.011158931069076061,
            0.01614314317703247,
            -0.0134156234562397,
            -0.03564440459012985,
            -0.0316423736512661,
            0.028329476714134216,
            -0.019641457125544548,
            -0.11094705760478973,
            0.011742250062525272,
            0.00046205008402466774,
            -0.033200040459632874,
            -0.0025859735906124115,
            0.008302930742502213,
            0.0014028102159500122,
            -0.034768592566251755,
            -0.003927845042198896,
            -0.030963197350502014,
            -0.001117727835662663,
            0.03759220615029335,
            0.11514084041118622,
            -0.006386455148458481,
            -0.03281372785568237,
            0.028983138501644135,
            -0.04312882944941521,
            -0.0331568568944931,
            0.007231660187244415,
            0.037765584886074066,
            0.009931404143571854,
            -0.047208890318870544,
            -0.032451797276735306,
            -0.052080415189266205,
            0.0012393640354275703,
            -0.05612178146839142,
            -0.021118197590112686,
            -0.004314466379582882,
            -0.0022288309410214424,
            -3.1789764761924744e-05,
            0.03286533057689667,
            -0.01995055563747883,
            -0.005907309707254171,
            -0.009585848078131676,
            0.03201839327812195,
            0.00041167379822582006,
            -0.04581353813409805,
            0.0008830130100250244,
            0.018795238807797432,
            -0.009761128574609756,
            -0.0525369755923748,
            -0.042110636830329895,
            0.012212369590997696,
            0.03422790393233299,
            -0.02899690344929695,
            -0.01503148302435875,
            -0.0001486707478761673,
            -0.08826625347137451,
            -0.030219953507184982,
            -0.010439697653055191,
            -0.022576289251446724,
            -0.18901002407073975,
            -0.026275601238012314,
            0.1511799395084381,
            0.02903466857969761,
            -0.0002919798716902733,
            0.010074369609355927,
            0.021311352029442787,
            -0.015165209770202637,
            -0.0158616341650486,
            -0.02955571562051773,
            -0.05264020711183548,
            -0.060544297099113464,
            -0.08390991389751434,
            0.025006990879774094,
            0.036482494324445724,
            -0.04133034497499466,
            0.01941303163766861,
            0.005991082638502121,
            0.031569577753543854,
            -0.038406360894441605,
            0.01832989975810051,
            0.009173751808702946,
            -0.014670896343886852,
            0.013782314956188202,
            0.015265614725649357,
            0.024282380938529968,
            0.03164776787161827,
            0.06294384598731995,
            -0.014697358012199402,
            -0.02244899608194828,
            -0.007612226996570826,
            0.011498495936393738,
            -0.010786403901875019,
            0.00018603872740641236,
            -0.01630004495382309,
            -0.027473364025354385,
            -0.04541058838367462,
            0.012195171788334846,
            -0.02031645178794861,
            0.1057237759232521,
            0.017952322959899902,
            -0.021611560136079788,
            -0.03851279988884926,
            -0.014518450945615768,
            -0.06675025820732117,
            0.016116300597786903,
            -0.030649863183498383,
            0.038807593286037445,
            -0.00521062221378088,
            -0.015920568257570267,
            0.0017735343426465988,
            -0.021751858294010162,
            0.01714296266436577,
            0.03147600218653679,
            -0.01968938484787941,
            0.10498411953449249,
            -0.10063479840755463,
            0.01741636171936989,
            0.016511712223291397,
            0.022285491228103638,
            0.03669975697994232,
            0.0009717796929180622,
            -0.059277355670928955,
            0.007456989958882332,
            0.0071670785546302795,
            -0.011731436476111412,
            0.014591439627110958,
            0.06042584404349327,
            -0.03095727041363716,
            0.018581083044409752,
            -0.03576575219631195,
            -0.08721581101417542,
            0.05106496065855026,
            -0.0020463019609451294,
            0.05293826386332512,
            0.03318989276885986,
            0.007440038025379181,
            0.008473378606140614,
            -0.0605505108833313,
            0.021211931481957436,
            0.00574912317097187,
            -0.06244831532239914,
            0.004712153226137161,
            -0.04863562434911728,
            -0.023815570399165154,
            0.020017029717564583,
            -0.0028006471693515778,
            -0.012570582330226898,
            0.024043980985879898,
            -0.044360995292663574,
            -0.000775075051933527,
            -0.057186976075172424,
            0.028397511690855026,
            0.012504992075264454,
            0.02956792712211609,
            0.011115817353129387,
            -0.014150826260447502,
            0.017223909497261047,
            0.07136663794517517,
            -0.013164328411221504,
            -0.03337930142879486,
            -0.03769101947546005,
            -0.0023307178635150194,
            0.02553223818540573,
            0.016593100503087044,
            0.002633986994624138,
            0.021166715770959854,
            -0.03426605463027954,
            -0.04495326429605484,
            -0.059512607753276825,
            0.01991727203130722,
            0.021892640739679337,
            0.002201736904680729,
            -0.0030131295789033175,
            0.0023207333870232105,
            0.2047935128211975,
            0.01607462204992771,
            -0.11255104839801788,
            0.017573002725839615,
            0.016660451889038086,
            0.03180817514657974,
            -0.037988804280757904,
            0.020006369799375534,
            -0.0016600186936557293,
            -0.08155849575996399,
            -0.011209124699234962,
            -0.05153436213731766,
            -0.02915087714791298,
            -0.013966862112283707,
            -0.027306023985147476,
            0.03382791206240654,
            0.03249156475067139,
            0.002817366272211075,
            0.04897178336977959,
            0.02955600991845131,
            -0.11578094959259033,
            -0.014633030630648136,
            0.03800181299448013,
            -0.06383654475212097,
            0.022655420005321503,
            0.04701433330774307,
            0.03566795215010643,
            -0.02638142555952072,
            0.0460432805120945,
            0.028190921992063522,
            -0.021663939580321312,
            -0.0026943739503622055,
            0.03971252217888832,
            -0.0036847367882728577,
            0.007738928310573101,
            0.0981694906949997,
            -0.0016315772663801908,
            -0.07020410150289536,
            -0.045543279498815536,
            -0.02746359258890152,
            0.04350415617227554,
            0.014236192218959332,
            0.023936577141284943,
            -0.055699340999126434,
            -0.05998113751411438,
            -0.0033033331856131554,
            -0.02792195975780487,
            -0.046412721276283264,
            -0.0449887216091156,
            0.003895182628184557,
            -0.005032714456319809,
            -0.03861119598150253,
            -0.013680877164006233,
            0.06499698013067245,
            0.03068559803068638,
            0.013113155961036682,
            -0.02477150782942772,
            0.007903741672635078,
            -0.021999165415763855,
            0.0035967398434877396,
            -0.005579270422458649,
            -0.028228018432855606,
            -0.012186979874968529,
            0.02124345675110817,
            0.0010138582438230515,
            0.00024323724210262299,
            0.0005628620274364948,
            0.044744137674570084,
            -0.01718100905418396,
            -0.018558228388428688,
            0.006711462512612343,
            -0.02760329283773899,
            0.052020493894815445,
            0.03741009533405304,
            0.023084979504346848,
            -0.007120829075574875,
            -0.09033183008432388,
            0.001072583720088005,
            0.02859477512538433,
            -0.013463949784636497,
            0.037051793187856674,
            0.01100076548755169,
            -0.016124654561281204,
            -0.005828775465488434,
            -0.01223178394138813,
            -0.016426164656877518,
            0.0173734650015831,
            -0.033954448997974396,
            0.0005379188805818558,
            -0.002602720633149147,
            0.020903795957565308,
            0.03339216113090515,
            -0.056377265602350235,
            0.011735379695892334,
            -0.07227456569671631,
            0.0029484033584594727,
            -0.016728101298213005,
            -0.0061609093099832535,
            0.043642252683639526,
            0.11111639440059662,
            0.02584679052233696,
            -0.027355609461665154,
            0.01926916278898716,
            -0.0005153771489858627,
            0.0015641674399375916,
            0.2901495695114136,
            -0.03552895784378052,
            -0.02722517028450966,
            -0.034177426248788834,
            -0.18530897796154022,
            0.0013782382011413574,
            -0.030186764895915985,
            -0.03811559081077576,
            -0.0022632074542343616,
            0.018187647685408592,
            1.0881572961807251e-05,
            0.013922576792538166,
            0.01334621012210846,
            0.04733964800834656,
            -0.03631052374839783,
            0.020138755440711975,
            -0.040787920355796814,
            0.007435061037540436,
            -0.06130179017782211,
            0.06323019415140152,
            0.006884083151817322,
            0.03717337176203728,
            -0.5028313398361206,
            0.01671931892633438,
            -0.0012020636349916458,
            0.01408112421631813,
            -0.020185504108667374,
            -0.01998548023402691,
            0.03184182941913605,
            -0.03285709023475647,
            0.03528981655836105,
            -0.04753235727548599,
            -0.027180880308151245,
            -0.10195507854223251,
            -0.0006210021674633026,
            0.07467280328273773,
            -0.0016580186784267426,
            0.05249861255288124,
            -0.030861787497997284,
            0.0083097442984581,
            -0.007075686473399401,
            0.03610710799694061,
            0.03006795421242714,
            -0.07243075221776962,
            0.013686642050743103,
            -0.031699761748313904,
            0.059072405099868774,
            -0.03991793468594551,
            -0.019059743732213974,
            -0.004753944464027882,
            0.029137752950191498,
            0.013847483322024345,
            -0.0038790274411439896,
            -0.0027469955384731293,
            0.003677237778902054,
            0.02333427220582962,
            -0.021876167505979538,
            0.10078969597816467,
            -0.00518945325165987,
            -0.0199617687612772,
            -0.0006216519977897406,
            0.058289509266614914,
            -0.035808395594358444,
            -0.023510843515396118,
            -0.0473652221262455,
            0.028196217492222786,
            -0.02648211270570755,
            0.023429540917277336,
            -0.012416206300258636,
            -0.018501432612538338,
            0.022488897666335106,
            -0.0018015019595623016,
            0.03027363121509552,
            -0.030054345726966858,
            -0.036723487079143524,
            -0.02424374595284462,
            -0.011204449459910393,
            -0.03259970247745514,
            0.0011232886463403702,
            -0.0024782465770840645,
            0.07083562016487122,
            -0.020856477320194244,
            -0.00032802764326334,
            -0.10430288314819336,
            -0.06655849516391754,
            0.02117639034986496,
            -0.01261584460735321,
            -0.11777400970458984,
            -0.04436836019158363,
            -0.03993044048547745,
            -0.00010604783892631531,
            -0.07818935811519623,
            -0.049460526555776596,
            -0.09664931893348694,
            0.034541741013526917,
            0.0487983301281929,
            -0.008073951117694378,
            -0.00012480467557907104,
            -0.03239821642637253,
            -0.019605092704296112,
            0.0038070715963840485,
            -0.03516601771116257,
            -0.04035564139485359,
            0.006953255273401737,
            -0.0011196872219443321,
            0.16883522272109985,
            0.03227171674370766,
            -0.044011905789375305,
            0.044008173048496246,
            0.039421871304512024,
            0.018475867807865143,
            -0.006347941234707832,
            -0.023159589618444443,
            0.013364244252443314,
            0.008231822401285172,
            -0.01080302894115448,
            -0.008046744391322136,
            -0.026408854871988297,
            -0.020815778523683548,
            -0.00039029913023114204,
            0.015397576615214348,
            0.18059547245502472,
            -0.0032937433570623398,
            0.03564292937517166,
            -0.017801959067583084,
            0.0005485415458679199,
            -0.027131740003824234,
            -0.0003998174797743559,
            -0.01825917512178421,
            0.35843729972839355,
            -0.02009686455130577,
            0.006933738477528095,
            -0.0005487799644470215,
        ]
    ],
    device=DEFAULT_DEVICE,
)


@pytest.fixture(scope="module")
def reference_clip_model(
    original_clip_download_dir: str,
) -> Generator[Tuple[nn.Module, callable], None, None]:
    lock_file = os.path.join(original_clip_download_dir, "clip_lock")
    with FileLock(lock_file=lock_file, timeout=120):
        original_model, preprocess = clip.load(
            "RN50",
            device=torch.device("cpu"),
            download_root=original_clip_download_dir,
        )
        yield original_model, preprocess


@pytest.mark.slow
def test_clip_torch_image_prediction_for_numpy(
    clip_rn50_pytorch_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)

    # when
    embeddings = model.embed_images(dog_image_numpy)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
def test_clip_torch_image_prediction_for_torch_tensor(
    clip_rn50_pytorch_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)

    # when
    embeddings = model.embed_images(dog_image_torch)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
def test_clip_predictions_for_image_are_comparable_with_reference_implementation(
    clip_rn50_pytorch_path: str,
    dog_image_torch: np.ndarray,
    dog_image_pil: Image,
    reference_clip_model: Tuple[nn.Module, callable],
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    inference_model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)
    original_model, preprocess = reference_clip_model
    dog_image_original_preprocessing = (
        preprocess(dog_image_pil).unsqueeze(0).to(torch.device("cpu"))
    )

    # when
    with torch.no_grad():
        original_image_features = original_model.encode_image(
            dog_image_original_preprocessing
        )
    inference_image_features = inference_model.embed_images(dog_image_torch)

    # then
    similarity = F.cosine_similarity(original_image_features, inference_image_features)
    assert (
        similarity >= 0.9985
    ), "We get different results due different input scaling PIL vs Torch"


@pytest.mark.slow
def test_clip_torch_image_text_embeddings(
    clip_rn50_pytorch_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    model = ClipTorch.from_pretrained(clip_rn50_pytorch_path, max_batch_size=2)

    # when
    embeddings = model.embed_text(["This is example text"] * 4)

    # then
    assert tuple(embeddings.shape) == (4, 1024)


@pytest.mark.slow
def test_clip_torch_image_text_embeddings_on_pair_with_reference_implementation(
    clip_rn50_pytorch_path: str,
    reference_clip_model: Tuple[nn.Module, callable],
) -> None:
    # given
    from inference_exp.models.clip.clip_pytorch import ClipTorch

    inference_model = ClipTorch.from_pretrained(clip_rn50_pytorch_path)
    original_model, _ = reference_clip_model
    text = clip.tokenize(["This is example text"]).to(torch.device("cpu"))

    # when
    with torch.no_grad():
        original_text_features = original_model.encode_text(text)
    inference_text_features = inference_model.embed_text("This is example text")

    # then
    assert torch.allclose(original_text_features, inference_text_features)


@pytest.mark.slow
@pytest.mark.onnx_extras
@pytest.mark.cpu_only
def test_clip_onnx_image_prediction_for_numpy(
    clip_rn50_onnx_path: str,
    dog_image_numpy: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_images(dog_image_numpy)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
@pytest.mark.onnx_extras
@pytest.mark.cpu_only
def test_clip_onnx_image_prediction_for_torch_tensor(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_images(dog_image_torch)

    # then
    assert tuple(embeddings.shape) == (1, 1024)
    assert torch.allclose(embeddings, EXPECTED_DOG_IMAGE_EMBEDDING, atol=1e-4)


@pytest.mark.slow
@pytest.mark.onnx_extras
@pytest.mark.cpu_only
def test_clip_onnx_image_prediction_similar_to_reference_implementation(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
    dog_image_pil: Image,
    original_clip_download_dir: str,
    reference_clip_model: Tuple[nn.Module, callable],
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    inference_model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    original_model, preprocess = reference_clip_model
    dog_image_original_preprocessing = (
        preprocess(dog_image_pil).unsqueeze(0).to(torch.device("cpu"))
    )

    # when
    with torch.no_grad():
        original_image_features = original_model.encode_image(
            dog_image_original_preprocessing
        )
    inference_image_features = inference_model.embed_images(dog_image_torch)

    # then
    similarity = F.cosine_similarity(original_image_features, inference_image_features)
    assert (
        similarity >= 0.9985
    ), "We get different results due different input scaling PIL vs Torch"


@pytest.mark.slow
@pytest.mark.onnx_extras
@pytest.mark.cpu_only
def test_clip_onnx_image_prediction_for_text(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    embeddings = model.embed_text("This is example text")

    # then
    assert tuple(embeddings.shape) == (1, 1024)


@pytest.mark.slow
@pytest.mark.onnx_extras
@pytest.mark.cpu_only
def test_clip_onnx_image_prediction_for_text_comparable_with_reference_implementation(
    clip_rn50_onnx_path: str,
    dog_image_torch: np.ndarray,
    reference_clip_model: Tuple[nn.Module, callable],
) -> None:
    # given
    from inference_exp.models.clip.clip_onnx import ClipOnnx

    inference_model = ClipOnnx.from_pretrained(
        clip_rn50_onnx_path, onnx_execution_providers=["CPUExecutionProvider"]
    )

    # when
    original_model, _ = reference_clip_model
    text = clip.tokenize(["This is example text"]).to(torch.device("cpu"))

    # when
    with torch.no_grad():
        original_text_features = original_model.encode_text(text)
    inference_text_features = inference_model.embed_text("This is example text")

    # then
    assert torch.allclose(original_text_features, inference_text_features, atol=1e-5)
