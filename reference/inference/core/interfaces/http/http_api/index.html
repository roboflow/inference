
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Scalable, on-device computer vision deployment.">
      
      
        <meta name="author" content="Roboflow">
      
      
        <link rel="canonical" href="https://inference.roboflow.com/reference/inference/core/interfaces/http/http_api/">
      
      
        <link rel="prev" href="../error_handlers/">
      
      
        <link rel="next" href="../builder/routes/">
      
      
        
      
      
      <link rel="icon" href="../../../../../../favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4+insiders-4.53.15">
    
    
      
        <title>Http api - Roboflow Inference</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.f15084e1.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7Cui-monospace:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"ui-monospace"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../../../styles/cookbooks.css">
    
      <link rel="stylesheet" href="../../../../../../styles.css">
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-T0CED2YY8K"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-T0CED2YY8K",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-T0CED2YY8K",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  
  

  
<meta property="og:type" content="website" />
<meta property="og:title" content="Http api - Roboflow Inference" />
<meta property="og:description" content="Scalable, on-device computer vision deployment." />
<meta property="og:image" content="https://inference.roboflow.com/assets/images/social/reference/inference/core/interfaces/http/http_api.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://inference.roboflow.com/reference/inference/core/interfaces/http/http_api/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Http api - Roboflow Inference" />
<meta property="twitter:description" content="Scalable, on-device computer vision deployment." />
<meta property="twitter:image" content="https://inference.roboflow.com/assets/images/social/reference/inference/core/interfaces/http/http_api.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#inference.core.interfaces.http.http_api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../.." title="Roboflow Inference" class="md-header__button md-logo" aria-label="Roboflow Inference" data-md-component="logo">
      
  <img src="../../../../../../roboflow-logomark-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Roboflow Inference
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Http api
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/roboflow/inference" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    roboflow/inference
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../start/overview/" class="md-tabs__link">
          
  
    
  
  Start

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../quickstart/run_a_model/" class="md-tabs__link">
          
  
    
  
  Models

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../workflows/about/" class="md-tabs__link">
          
  
    
  
  Workflows

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../../../quickstart/roboflow_ecosystem/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../workflows/gallery/basic_workflows/" class="md-tabs__link">
          
  
    
  
  Examples

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
  
        
      
  

      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="Roboflow Inference" class="md-nav__button md-logo" aria-label="Roboflow Inference" data-md-component="logo">
      
  <img src="../../../../../../roboflow-logomark-white.svg" alt="logo">

    </a>
    Roboflow Inference
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/roboflow/inference" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    roboflow/inference
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../start/overview/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Start
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../quickstart/run_a_model/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../workflows/about/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../quickstart/roboflow_ecosystem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Roboflow Ecosystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../using_inference/inference_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    InferencePipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../inference_helpers/inference_sdk/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Python SDK
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../inference_helpers/inference_cli/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Command Line Interface
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../api/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    HTTP API
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    inference Python Package
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    inference Python Package
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_6_2" id="__nav_4_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_6_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../nms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Nms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../roboflow_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Roboflow api
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../active_learning/accounting/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Active learning
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../cache/base/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Cache
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../devices/utils/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Devices
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../entities/requests/clip/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Entities
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6_2_9" checked>
        
          
          <label class="md-nav__link" for="__nav_4_6_2_9" id="__nav_4_6_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Interfaces
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_6_2_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Interfaces
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../camera/camera/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Camera
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6_2_9_3" checked>
        
          
          <label class="md-nav__link" for="__nav_4_6_2_9_3" id="__nav_4_6_2_9_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Http
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_4_6_2_9_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_6_2_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Http
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../error_handlers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Error handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    Http api
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    Http api
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api" class="md-nav__link">
    <span class="md-ellipsis">
      
        http_api
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.HttpInterface" class="md-nav__link">
    <span class="md-ellipsis">
      
        HttpInterface
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HttpInterface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.HttpInterface.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.load_gaze_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_gaze_model
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../builder/routes/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Builder
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../middlewares/cors/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Middlewares
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../stream/sinks/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Stream
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../udp/udp_stream/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Udp
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../logging/memory_handler/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Logging
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../managers/base/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Managers
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../models/base/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../registries/base/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Registries
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../utils/container/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Utils
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    
  
  
    
  
  
    <a href="../../../workflows/core_steps/classical_cv/camera_focus/v1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

  

  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../enterprise/parallel/dispatch_manager/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Enterprise
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../../models/clip/clip_model/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../usage_tracking/redis_queue/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Usage tracking
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../enterprise/parallel_processing/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Enterprise Features
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../quickstart/docker/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Server Configuration
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Contribute to Inference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/roboflow/inference/releases" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../../../workflows/gallery/basic_workflows/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api" class="md-nav__link">
    <span class="md-ellipsis">
      
        http_api
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.HttpInterface" class="md-nav__link">
    <span class="md-ellipsis">
      
        HttpInterface
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HttpInterface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.HttpInterface.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inference.core.interfaces.http.http_api.load_gaze_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_gaze_model
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  
    
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/roboflow/inference/tree/main/inference/core/interfaces/http/http_api.py" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>Http api</h1>

<div class="doc doc-object doc-module">



<a id="inference.core.interfaces.http.http_api"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="inference.core.interfaces.http.http_api.HttpInterface" class="doc doc-heading">
            <code>HttpInterface</code>


<a href="#inference.core.interfaces.http.http_api.HttpInterface" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="../../base/#inference.core.interfaces.base.BaseInterface">BaseInterface</a></code></p>


        <p>Roboflow defined HTTP interface for a general-purpose inference server.</p>
<p>This class sets up the FastAPI application and adds necessary middleware,
as well as initializes the model manager and model registry for the inference server.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="inference.core.interfaces.http.http_api.HttpInterface.app">app</span></code></td>
            <td>
                  <code><span title="fastapi.FastAPI">FastAPI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI application instance.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="inference.core.interfaces.http.http_api.HttpInterface.model_manager">model_manager</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" href="../../../managers/base/#inference.core.managers.base.ModelManager">ModelManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The manager for handling different models.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>inference/core/interfaces/http/http_api.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HttpInterface</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Roboflow defined HTTP interface for a general-purpose inference server.</span>

<span class="sd">    This class sets up the FastAPI application and adds necessary middleware,</span>
<span class="sd">    as well as initializes the model manager and model registry for the inference server.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        app (FastAPI): The FastAPI application instance.</span>
<span class="sd">        model_manager (ModelManager): The manager for handling different models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_manager</span><span class="p">:</span> <span class="n">ModelManager</span><span class="p">,</span>
        <span class="n">root_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the HttpInterface with given model manager and model registry.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_manager (ModelManager): The manager for handling different models.</span>
<span class="sd">            root_path (Optional[str]): The root path for the FastAPI application.</span>

<span class="sd">        Description:</span>
<span class="sd">            Deploy Roboflow trained models to nearly any compute environment!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Roboflow inference server&quot;</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Roboflow Inference Server&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">terms_of_service</span><span class="o">=</span><span class="s2">&quot;https://roboflow.com/terms&quot;</span><span class="p">,</span>
            <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Roboflow Inc.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://roboflow.com/contact&quot;</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;help@roboflow.com&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Apache 2.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">root_path</span><span class="o">=</span><span class="n">root_path</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Ensure in-memory logging is initialized as early as possible for all runtimes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.logging.memory_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_memory_logging</span>

            <span class="n">setup_memory_logging</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
            <span class="s2">&quot;/static&quot;</span><span class="p">,</span>
            <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out/static&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
            <span class="s2">&quot;/_next/static&quot;</span><span class="p">,</span>
            <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out/_next/static&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_next_static&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;shutdown&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_shutdown</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">usage_collector</span><span class="o">.</span><span class="n">async_push_usage_payloads</span><span class="p">()</span>

        <span class="n">InferenceInstrumentator</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">LambdaMiddleware</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">GCPServerlessMiddleware</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ALLOW_ORIGINS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Add CORS Middleware (but not for /build**, which is controlled separately)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
                <span class="n">PathAwareCORSMiddleware</span><span class="p">,</span>
                <span class="n">match_paths</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^(?!/build).*&quot;</span><span class="p">,</span>
                <span class="n">allow_origins</span><span class="o">=</span><span class="n">ALLOW_ORIGINS</span><span class="p">,</span>
                <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
                <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
                <span class="n">expose_headers</span><span class="o">=</span><span class="p">[</span><span class="n">PROCESSING_TIME_HEADER</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Optionally add middleware for profiling the FastAPI server and underlying inference API code</span>
        <span class="k">if</span> <span class="n">PROFILE</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
                <span class="n">CProfileMiddleware</span><span class="p">,</span>
                <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">server_app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;/profile/output.pstats&quot;</span><span class="p">,</span>
                <span class="n">strip_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;cumulative&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">API_LOGGING_ENABLED</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
                <span class="n">asgi_correlation_id</span><span class="o">.</span><span class="n">CorrelationIdMiddleware</span><span class="p">,</span>
                <span class="n">header_name</span><span class="o">=</span><span class="n">CORRELATION_ID_HEADER</span><span class="p">,</span>
                <span class="n">update_request_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">generator</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">transformer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">asgi_correlation_id</span><span class="o">.</span><span class="n">CorrelationIdMiddleware</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">METRICS_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">count_errors</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Middleware to count errors.</span>

<span class="sd">                Args:</span>
<span class="sd">                    request (Request): The incoming request.</span>
<span class="sd">                    call_next (Callable): The next middleware or endpoint to call.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Response: The response from the next middleware or endpoint.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">pingback</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">num_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/device/stats&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">device_stats</span><span class="p">():</span>
                <span class="n">not_configured_error_message</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Device statistics endpoint is not enabled.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Mount the Docker socket and point its location when running the docker &quot;</span>
                    <span class="s2">&quot;container to collect device stats &quot;</span>
                    <span class="s2">&quot;(i.e. `docker run ... -v /var/run/docker.sock:/var/run/docker.sock &quot;</span>
                    <span class="s2">&quot;-e DOCKER_SOCKET_PATH=/var/run/docker.sock ...`).&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCKER_SOCKET_PATH</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">not_configured_error_message</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_docker_socket_mounted</span><span class="p">(</span><span class="n">docker_socket_path</span><span class="o">=</span><span class="n">DOCKER_SOCKET_PATH</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">not_configured_error_message</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">container_stats</span> <span class="o">=</span> <span class="n">get_container_stats</span><span class="p">(</span>
                    <span class="n">docker_socket_path</span><span class="o">=</span><span class="n">DOCKER_SOCKET_PATH</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">container_stats</span><span class="p">)</span>

        <span class="n">cached_api_keys</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_authorization_serverless</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
                <span class="c1"># exclusions</span>
                <span class="n">skip_check</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
                    <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/healthz&quot;</span><span class="p">,</span>  <span class="c1"># health check endpoint for liveness probe</span>
                        <span class="s2">&quot;/readiness&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/metrics&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>  <span class="c1"># needed for /docs and /redoc</span>
                        <span class="s2">&quot;/model/registry&quot;</span><span class="p">,</span>  <span class="c1"># dont auth this route, usually not used on serverlerless, but queue based serverless uses it internally (not accessible from outside)</span>
                    <span class="p">]</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/static/&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/_next/&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># for these routes we only want to auth if dynamic python modules are provided</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/workflows/definition/schema&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                        <span class="n">skip_check</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">):</span>
                        <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;dynamic_blocks_definitions&quot;</span><span class="p">,</span> <span class="kc">None</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamic_blocks_definitions</span><span class="p">:</span>
                            <span class="n">skip_check</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">skip_check</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_unauthorized_response</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="n">req_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>
                <span class="n">json_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">req_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                    <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="c1"># have to try catch here, because some legacy endpoints that abuse Content-Type header but dont actually receive json</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cached_api_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">get_roboflow_workspace_async</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                        <span class="n">cached_api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span>
                        <span class="p">)</span>  <span class="c1"># expired after 1 hour</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span> <span class="n">WorkspaceLoadError</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_authorization</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
                <span class="c1"># exclusions</span>
                <span class="n">skip_check</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
                    <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/healthz&quot;</span><span class="p">,</span>  <span class="c1"># health check endpoint for liveness probe</span>
                        <span class="s2">&quot;/readiness&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/metrics&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>  <span class="c1"># needed for /docs and /redoc</span>
                    <span class="p">]</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/static/&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/_next/&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">skip_check</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_unauthorized_response</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># check api_key</span>
                <span class="n">req_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>
                <span class="n">json_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">req_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                    <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="c1"># have to try catch here, because some legacy endpoints that abuse Content-Type header but dont actually receive json</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cached_api_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># TODO: make this request async!</span>
                        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">workspace_url</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">workspace_url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_roboflow_workspace_async</span><span class="p">(</span>
                                <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">workspace_url</span> <span class="o">!=</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                        <span class="n">cached_api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span>
                        <span class="p">)</span>  <span class="c1"># expired after 1 hour</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span> <span class="n">WorkspaceLoadError</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span> <span class="o">=</span> <span class="n">model_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StreamManagerClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ENABLE_STREAM_API</span><span class="p">:</span>
            <span class="n">operations_timeout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_OPERATIONS_TIMEOUT&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">operations_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">operations_timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">operations_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span> <span class="o">=</span> <span class="n">StreamManagerClient</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">),</span>
                <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;7070&quot;</span><span class="p">)),</span>
                <span class="n">operations_timeout</span><span class="o">=</span><span class="n">operations_timeout</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_inference_request</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">InferenceRequest</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResponse</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Processes an inference request by calling the appropriate model.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (InferenceRequest): The request containing model ID and other inference details.</span>
<span class="sd">                countinference (Optional[bool]): Whether to count inference for usage.</span>
<span class="sd">                service_secret (Optional[str]): The service secret.</span>

<span class="sd">            Returns:</span>
<span class="sd">                InferenceResponse: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                <span class="n">de_aliased_model_id</span><span class="p">,</span>
                <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                <span class="n">de_aliased_model_id</span><span class="p">,</span> <span class="n">inference_request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_workflow_inference_request</span><span class="p">(</span>
            <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowInferenceRequest</span><span class="p">,</span>
            <span class="n">workflow_specification</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BackgroundTasks</span><span class="p">],</span>
            <span class="n">profiler</span><span class="p">:</span> <span class="n">WorkflowsProfiler</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>

            <span class="n">workflow_init_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;workflows_core.model_manager&quot;</span><span class="p">:</span> <span class="n">model_manager</span><span class="p">,</span>
                <span class="s2">&quot;workflows_core.api_key&quot;</span><span class="p">:</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="s2">&quot;workflows_core.background_tasks&quot;</span><span class="p">:</span> <span class="n">background_tasks</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">execution_engine</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">workflow_definition</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
                <span class="n">init_parameters</span><span class="o">=</span><span class="n">workflow_init_parameters</span><span class="p">,</span>
                <span class="n">max_concurrent_steps</span><span class="o">=</span><span class="n">WORKFLOWS_MAX_CONCURRENT_STEPS</span><span class="p">,</span>
                <span class="n">prevent_local_images_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
                <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">is_preview</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">workflow_request</span><span class="p">,</span> <span class="s2">&quot;is_preview&quot;</span><span class="p">):</span>
                <span class="n">is_preview</span> <span class="o">=</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">is_preview</span>
            <span class="n">workflow_results</span> <span class="o">=</span> <span class="n">execution_engine</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">runtime_parameters</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
                <span class="n">serialize_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">_is_preview</span><span class="o">=</span><span class="n">is_preview</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">profile_execution_phase</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workflow_results_filtering&quot;</span><span class="p">,</span>
                <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inference_package_operation&quot;</span><span class="p">],</span>
            <span class="p">):</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">filter_out_unwanted_workflow_outputs</span><span class="p">(</span>
                    <span class="n">workflow_results</span><span class="o">=</span><span class="n">workflow_results</span><span class="p">,</span>
                    <span class="n">excluded_fields</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">excluded_fields</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">profiler_trace</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">export_trace</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">WorkflowInferenceResponse</span><span class="p">(</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
                <span class="n">profiler_trace</span><span class="o">=</span><span class="n">profiler_trace</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">load_core_model</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">InferenceRequest</span><span class="p">,</span>
            <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">core_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Loads a core model (e.g., &quot;clip&quot; or &quot;sam&quot;) into the model manager.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (InferenceRequest): The request containing version and other details.</span>
<span class="sd">                api_key (Optional[str]): The API key for the request.</span>
<span class="sd">                core_model (str): The core model type, e.g., &quot;clip&quot; or &quot;sam&quot;.</span>
<span class="sd">                countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">                service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">            Returns:</span>
<span class="sd">                str: The core model ID.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
            <span class="n">version_id_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_model</span><span class="si">}</span><span class="s2">_version_id&quot;</span>
            <span class="n">core_model_id</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_model</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inference_request</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">version_id_field</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                <span class="n">core_model_id</span><span class="p">,</span>
                <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">endpoint_type</span><span class="o">=</span><span class="n">ModelEndpointType</span><span class="o">.</span><span class="n">CORE_MODEL</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">core_model_id</span>

        <span class="n">load_clip_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the CLIP model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The CLIP model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_pe_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;perception_encoder&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the Perception Encoder model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The Perception Encoder model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_sam_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;sam&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the SAM model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The SAM model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">load_sam2_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;sam2&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the SAM2 model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The SAM2 model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_gaze_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;gaze&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the GAZE model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The GAZE model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_doctr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;doctr&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the DocTR model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The DocTR model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_easy_ocr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;easy_ocr&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the EasyOCR model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The EasyOCR model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_paligemma_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;paligemma&quot;</span><span class="p">)</span>

        <span class="n">load_grounding_dino_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;grounding_dino&quot;</span>
        <span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the Grounding DINO model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The Grounding DINO model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_yolo_world_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;yolo_world&quot;</span><span class="p">)</span>
        <span class="n">load_owlv2_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;owlv2&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the YOLO World model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The YOLO World model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">load_trocr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;trocr&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads the TrOCR model into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">        Same as `load_core_model`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        The TrOCR model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ServerVersionInfo</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Info&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get the server name and version number&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Endpoint to get the server name and version number.</span>

<span class="sd">            Returns:</span>
<span class="sd">                ServerVersionInfo: The server version information.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">ServerVersionInfo</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Roboflow Inference Server&quot;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
                <span class="n">uuid</span><span class="o">=</span><span class="n">GLOBAL_INFERENCE_SERVER_ID</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/logs&quot;</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Get Recent Logs&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get recent application logs for debugging&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_logs</span><span class="p">(</span>
            <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of log entries to return&quot;</span>
            <span class="p">),</span>
            <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filter by log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">since</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Return logs since this ISO timestamp&quot;</span>
            <span class="p">),</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get recent application logs from memory.</span>

<span class="sd">            Only available when ENABLE_IN_MEMORY_LOGS environment variable is set to &#39;true&#39;.</span>

<span class="sd">            Args:</span>
<span class="sd">                limit: Maximum number of log entries (default 100)</span>
<span class="sd">                level: Filter by log level</span>
<span class="sd">                since: ISO timestamp to filter logs since</span>

<span class="sd">            Returns:</span>
<span class="sd">                List of log entries with timestamp, level, logger, and message</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Check if in-memory logging is enabled</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.logging.memory_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">get_recent_logs</span><span class="p">,</span>
                <span class="n">is_memory_logging_enabled</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_memory_logging_enabled</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Logs endpoint not available&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">get_recent_logs</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="ow">or</span> <span class="mi">100</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)}</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Logging system not properly initialized&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">LAMBDA</span> <span class="ow">and</span> <span class="n">GET_MODEL_REGISTRY_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/model/registry&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Get model keys&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get the ID of each loaded model&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">registry</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Get the ID of each loaded model in the registry.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/registry&quot;</span><span class="p">)</span>
                <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                    <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
                <span class="p">)</span>

        <span class="c1"># The current AWS Lambda authorizer only supports path parameters, therefore we can only use the legacy infer route. This case statement excludes routes which won&#39;t work for the current Lambda authorizer.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/model/add&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Load a model&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Load the model with the given model ID&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">model_add</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">AddModelRequest</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Load the model with the given model ID into the model manager.</span>

<span class="sd">                Args:</span>
<span class="sd">                    request (AddModelRequest): The request containing the model ID and optional API key.</span>
<span class="sd">                    countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">                    service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/add&quot;</span><span class="p">)</span>
                <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_id</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading model: </span><span class="si">{</span><span class="n">de_aliased_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                    <span class="n">de_aliased_model_id</span><span class="p">,</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                    <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/model/remove&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Remove a model&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove the model with the given model ID&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">model_remove</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">ClearModelRequest</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Remove the model with the given model ID from the model manager.</span>

<span class="sd">                Args:</span>
<span class="sd">                    request (ClearModelRequest): The request containing the model ID to be removed.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/remove&quot;</span><span class="p">)</span>
                <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_id</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">de_aliased_model_id</span><span class="p">)</span>
                <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                    <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/model/clear&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Remove all models&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove all loaded models&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">model_clear</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Remove all loaded models from the model manager.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/clear&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                    <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
                <span class="p">)</span>

        <span class="c1"># these NEW endpoints need authentication protection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LAMBDA</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/object_detection&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">List</span><span class="p">[</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">],</span>
                    <span class="n">StubResponse</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Object detection infer&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified object detection model&quot;</span><span class="p">,</span>
                <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_object_detection</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">ObjectDetectionInferenceRequest</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Run inference with the specified object detection model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ObjectDetectionInferenceRequest): The request containing the necessary details for object detection.</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Union[ObjectDetectionInferenceResponse, List[ObjectDetectionInferenceResponse]]: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/object_detection&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/instance_segmentation&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span> <span class="n">StubResponse</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Instance segmentation infer&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified instance segmentation model&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_instance_segmentation</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">InstanceSegmentationInferenceRequest</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Run inference with the specified instance segmentation model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (InstanceSegmentationInferenceRequest): The request containing the necessary details for instance segmentation.</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                Returns:</span>
<span class="sd">                    InstanceSegmentationInferenceResponse: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/instance_segmentation&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/classification&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">StubResponse</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Classification infer&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified classification model&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_classification</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClassificationInferenceRequest</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Run inference with the specified classification model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ClassificationInferenceRequest): The request containing the necessary details for classification.</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Union[ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse]: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/classification&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/keypoints_detection&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span> <span class="n">StubResponse</span><span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Keypoints detection infer&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified keypoints detection model&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_keypoints</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">KeypointsDetectionInferenceRequest</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Run inference with the specified keypoints detection model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (KeypointsDetectionInferenceRequest): The request containing the necessary details for keypoints detection.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Union[ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse]: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/keypoints_detection&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">LMM_ENABLED</span> <span class="ow">or</span> <span class="n">MOONDREAM2_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/infer/lmm&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                        <span class="n">LMMInferenceResponse</span><span class="p">,</span>
                        <span class="n">List</span><span class="p">[</span><span class="n">LMMInferenceResponse</span><span class="p">],</span>
                        <span class="n">StubResponse</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Large multi-modal model infer&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified large multi-modal model&quot;</span><span class="p">,</span>
                    <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">infer_lmm</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">LMMInferenceRequest</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Run inference with the specified object detection model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (ObjectDetectionInferenceRequest): The request containing the necessary details for object detection.</span>
<span class="sd">                        background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        Union[ObjectDetectionInferenceResponse, List[ObjectDetectionInferenceResponse]]: The response containing the inference results.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/lmm&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">DISABLE_WORKFLOW_ENDPOINTS</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/</span><span class="si">{workspace_name}</span><span class="s2">/workflows/</span><span class="si">{workflow_id}</span><span class="s2">/describe_interface&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">DescribeInterfaceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to describe interface of predefined workflow&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - describes workflow inputs and outputs&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">describe_predefined_workflow_interface</span><span class="p">(</span>
                <span class="n">workspace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">workflow_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">workflow_request</span><span class="p">:</span> <span class="n">PredefinedWorkflowDescribeInterfaceRequest</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DescribeInterfaceResponse</span><span class="p">:</span>
                <span class="n">workflow_specification</span> <span class="o">=</span> <span class="n">get_workflow_specification</span><span class="p">(</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">workspace_id</span><span class="o">=</span><span class="n">workspace_name</span><span class="p">,</span>
                    <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
                    <span class="n">use_cache</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">handle_describe_workflows_interface</span><span class="p">(</span>
                    <span class="n">definition</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/describe_interface&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">DescribeInterfaceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to describe interface of workflow given in request&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses workflow definition and retrieves describes inputs and outputs&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflow_interface</span><span class="p">(</span>
                <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowSpecificationDescribeInterfaceRequest</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DescribeInterfaceResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">handle_describe_workflows_interface</span><span class="p">(</span>
                    <span class="n">definition</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">specification</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/</span><span class="si">{workspace_name}</span><span class="s2">/workflows/</span><span class="si">{workflow_id}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to run predefined workflow&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - parses and executes injecting runtime parameters from request body&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/workflows/</span><span class="si">{workspace_name}</span><span class="s2">/</span><span class="si">{workflow_id}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to run predefined workflow&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - parses and executes injecting runtime parameters from request body. This endpoint is deprecated and will be removed end of Q2 2024&quot;</span><span class="p">,</span>
                <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_from_predefined_workflow</span><span class="p">(</span>
                <span class="n">workspace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">workflow_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">workflow_request</span><span class="p">:</span> <span class="n">PredefinedWorkflowInferenceRequest</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="k">if</span> <span class="n">ENABLE_WORKFLOWS_PROFILING</span> <span class="ow">and</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
                    <span class="n">profiler</span> <span class="o">=</span> <span class="n">BaseWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                        <span class="n">max_runs_in_buffer</span><span class="o">=</span><span class="n">WORKFLOWS_PROFILER_BUFFER_SIZE</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profiler</span> <span class="o">=</span> <span class="n">NullWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">profile_execution_phase</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workflow_definition_fetching&quot;</span><span class="p">,</span>
                    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inference_package_operation&quot;</span><span class="p">],</span>
                <span class="p">):</span>
                    <span class="n">workflow_specification</span> <span class="o">=</span> <span class="n">get_workflow_specification</span><span class="p">(</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">workspace_id</span><span class="o">=</span><span class="n">workspace_name</span><span class="p">,</span>
                        <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span><span class="p">:</span>
                    <span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span> <span class="o">=</span> <span class="n">workflow_id</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_specification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Internal workflow ID missing in specification for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="n">workflow_id</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">process_workflow_inference_request</span><span class="p">(</span>
                    <span class="n">workflow_request</span><span class="o">=</span><span class="n">workflow_request</span><span class="p">,</span>
                    <span class="n">workflow_specification</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">background_tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/run&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to run workflow specification provided in payload&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses and executes workflow specification, injecting runtime parameters from request body.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/workflows&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to run workflow specification provided in payload&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses and executes workflow specification, injecting runtime parameters from request body. This endpoint is deprecated and will be removed end of Q2 2024.&quot;</span><span class="p">,</span>
                <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_from_workflow</span><span class="p">(</span>
                <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowSpecificationInferenceRequest</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="k">if</span> <span class="n">ENABLE_WORKFLOWS_PROFILING</span> <span class="ow">and</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
                    <span class="n">profiler</span> <span class="o">=</span> <span class="n">BaseWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                        <span class="n">max_runs_in_buffer</span><span class="o">=</span><span class="n">WORKFLOWS_PROFILER_BUFFER_SIZE</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profiler</span> <span class="o">=</span> <span class="n">NullWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">process_workflow_inference_request</span><span class="p">(</span>
                    <span class="n">workflow_request</span><span class="o">=</span><span class="n">workflow_request</span><span class="p">,</span>
                    <span class="n">workflow_specification</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">specification</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">background_tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/execution_engine/versions&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ExecutionEngineVersions</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Returns available Execution Engine versions sorted from oldest to newest&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Returns available Execution Engine versions sorted from oldest to newest&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_execution_engine_versions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ExecutionEngineVersions</span><span class="p">:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="n">versions</span> <span class="o">=</span> <span class="n">get_available_versions</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">ExecutionEngineVersions</span><span class="p">(</span><span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to get definition of workflows blocks that are accessible&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides detailed information about workflows building blocks that are &quot;</span>
                <span class="s2">&quot;accessible in the inference server. This information could be used to programmatically &quot;</span>
                <span class="s2">&quot;build / display workflows.&quot;</span><span class="p">,</span>
                <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflows_blocks</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">handle_describe_workflows_blocks_request</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to get definition of workflows blocks that are accessible&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides detailed information about workflows building blocks that are &quot;</span>
                <span class="s2">&quot;accessible in the inference server. This information could be used to programmatically &quot;</span>
                <span class="s2">&quot;build / display workflows. Additionally - in request body one can specify list of &quot;</span>
                <span class="s2">&quot;dynamic blocks definitions which will be transformed into blocks and used to generate &quot;</span>
                <span class="s2">&quot;schemas and definitions of connections&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflows_blocks</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">request_payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DescribeBlocksRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">requested_execution_engine_version</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">request_payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">request_payload</span><span class="o">.</span><span class="n">dynamic_blocks_definitions</span>
                    <span class="p">)</span>
                    <span class="n">requested_execution_engine_version</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">request_payload</span><span class="o">.</span><span class="n">execution_engine_version</span>
                    <span class="p">)</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">api_key</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">handle_describe_workflows_blocks_request</span><span class="p">(</span>
                    <span class="n">dynamic_blocks_definitions</span><span class="o">=</span><span class="n">dynamic_blocks_definitions</span><span class="p">,</span>
                    <span class="n">requested_execution_engine_version</span><span class="o">=</span><span class="n">requested_execution_engine_version</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/definition/schema&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksSchemaDescription</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to fetch the workflows block schema&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint to fetch the schema of all available blocks. This information can be &quot;</span>
                <span class="s2">&quot;used to validate workflow definitions and suggest syntax in the JSON editor.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_workflow_schema</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowsBlocksSchemaDescription</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_workflow_schema_description</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/blocks/dynamic_outputs&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to get definition of dynamic output for workflow step&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint to be used when step outputs can be discovered only after &quot;</span>
                <span class="s2">&quot;filling manifest with data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_dynamic_block_outputs</span><span class="p">(</span>
                <span class="n">step_manifest</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="c1"># Potentially TODO: dynamic blocks do not support dynamic outputs, but if it changes</span>
                <span class="c1"># we need to provide dynamic blocks manifests here</span>
                <span class="n">dummy_workflow_definition</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">step_manifest</span><span class="p">],</span>
                    <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>
                <span class="n">available_blocks</span> <span class="o">=</span> <span class="n">load_workflow_blocks</span><span class="p">()</span>
                <span class="n">parsed_definition</span> <span class="o">=</span> <span class="n">parse_workflow_definition</span><span class="p">(</span>
                    <span class="n">raw_workflow_definition</span><span class="o">=</span><span class="n">dummy_workflow_definition</span><span class="p">,</span>
                    <span class="n">available_blocks</span><span class="o">=</span><span class="n">available_blocks</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">parsed_manifest</span> <span class="o">=</span> <span class="n">parsed_definition</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">parsed_manifest</span><span class="o">.</span><span class="n">get_actual_outputs</span><span class="p">()</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/workflows/validate&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowValidationStatus</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to validate&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides a way to check validity of JSON workflow definition.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">validate_workflow</span><span class="p">(</span>
                <span class="n">specification</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowValidationStatus</span><span class="p">:</span>
                <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
                <span class="n">step_execution_mode</span> <span class="o">=</span> <span class="n">StepExecutionMode</span><span class="p">(</span><span class="n">WORKFLOWS_STEP_EXECUTION_MODE</span><span class="p">)</span>
                <span class="n">workflow_init_parameters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;workflows_core.model_manager&quot;</span><span class="p">:</span> <span class="n">model_manager</span><span class="p">,</span>
                    <span class="s2">&quot;workflows_core.api_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;workflows_core.background_tasks&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;workflows_core.step_execution_mode&quot;</span><span class="p">:</span> <span class="n">step_execution_mode</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                    <span class="n">workflow_definition</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span>
                    <span class="n">init_parameters</span><span class="o">=</span><span class="n">workflow_init_parameters</span><span class="p">,</span>
                    <span class="n">max_concurrent_steps</span><span class="o">=</span><span class="n">WORKFLOWS_MAX_CONCURRENT_STEPS</span><span class="p">,</span>
                    <span class="n">prevent_local_images_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">WorkflowValidationStatus</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">WEBRTC_WORKER_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/initialise_webrtc_worker&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">InitializeWebRTCResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and processes video stream in spawned process or modal function&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and processes video stream in spawned process or modal function&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise_webrtc_worker</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">WebRTCWorkerRequest</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InitializeWebRTCResponse</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received initialise_webrtc_worker request&quot;</span><span class="p">)</span>
                <span class="n">worker_result</span><span class="p">:</span> <span class="n">WebRTCWorkerResult</span> <span class="o">=</span> <span class="k">await</span> <span class="n">start_worker</span><span class="p">(</span>
                    <span class="n">webrtc_request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span> <span class="o">==</span> <span class="s2">&quot;WorkflowSyntaxError&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowSyntaxError</span><span class="p">(</span>
                            <span class="n">public_message</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_context</span><span class="p">,</span>
                            <span class="n">inner_error</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">inner_error</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">expected_exceptions</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;Exception&quot;</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
                        <span class="s2">&quot;KeyError&quot;</span><span class="p">:</span> <span class="ne">KeyError</span><span class="p">,</span>
                        <span class="s2">&quot;MissingApiKeyError&quot;</span><span class="p">:</span> <span class="n">MissingApiKeyError</span><span class="p">,</span>
                        <span class="s2">&quot;NotImplementedError&quot;</span><span class="p">:</span> <span class="ne">NotImplementedError</span><span class="p">,</span>
                        <span class="s2">&quot;RoboflowAPINotAuthorizedError&quot;</span><span class="p">:</span> <span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span>
                        <span class="s2">&quot;RoboflowAPINotNotFoundError&quot;</span><span class="p">:</span> <span class="n">RoboflowAPINotNotFoundError</span><span class="p">,</span>
                        <span class="s2">&quot;ValidationError&quot;</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">expected_exceptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span><span class="p">,</span> <span class="ne">Exception</span>
                    <span class="p">)(</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Initialise webrtc worker failed with %s: %s&quot;</span><span class="p">,</span>
                        <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span><span class="p">,</span>
                        <span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exc</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning initialise_webrtc_worker response&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitializeWebRTCResponse</span><span class="p">(</span>
                    <span class="n">context</span><span class="o">=</span><span class="n">CommandContext</span><span class="p">(),</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">OperationStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
                    <span class="n">sdp</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">sdp</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">ENABLE_STREAM_API</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/list&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ListPipelinesResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] List active InferencePipelines&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Listing all active InferencePipelines processing videos&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_pipelines</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ListPipelinesResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">list_pipelines</span><span class="p">()</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/status&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">InferencePipelineStatusResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Get status of InferencePipeline&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Get status of InferencePipeline&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_status</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferencePipelineStatusResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span>
                    <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/initialise&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Starts new InferencePipeline&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Starts new InferencePipeline&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">InitialisePipelinePayload</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">initialise_pipeline</span><span class="p">(</span>
                    <span class="n">initialisation_request</span><span class="o">=</span><span class="n">request</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/initialise_webrtc&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">InitializeWebRTCPipelineResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and starts new InferencePipeline consuming video track&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and starts new InferencePipeline consuming video track&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise_webrtc_inference_pipeline</span><span class="p">(</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">InitialiseWebRTCPipelinePayload</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received initialise webrtc inference pipeline request&quot;</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">initialise_webrtc_pipeline</span><span class="p">(</span>
                    <span class="n">initialisation_request</span><span class="o">=</span><span class="n">request</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning initialise webrtc inference pipeline response&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">resp</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/pause&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Pauses the InferencePipeline&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Pauses the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">pause_pipeline</span><span class="p">(</span>
                    <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/resume&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Resumes the InferencePipeline&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Resumes the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">resume</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">resume_pipeline</span><span class="p">(</span>
                    <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/terminate&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Terminates the InferencePipeline&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Terminates the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">terminate_pipeline</span><span class="p">(</span>
                    <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
                <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/consume&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ConsumePipelineResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Consumes InferencePipeline result&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Consumes InferencePipeline result&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions_async</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsumeResultsPayload</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConsumePipelineResponse</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">ConsumeResultsPayload</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">consume_pipeline_result</span><span class="p">(</span>
                    <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span><span class="p">,</span>
                    <span class="n">excluded_fields</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">excluded_fields</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Enable preloading models at startup</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">PRELOAD_MODELS</span> <span class="ow">or</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">API_KEY</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span>
        <span class="p">):</span>

            <span class="k">class</span><span class="w"> </span><span class="nc">ModelInitState</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Class to track model initialization state.&quot;&quot;&quot;</span>

                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># For thread-safe updates</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialization_errors</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track errors per model</span>

            <span class="n">model_init_state</span> <span class="o">=</span> <span class="n">ModelInitState</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">initialize_models</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ModelInitState</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Perform asynchronous initialization tasks to load models.&quot;&quot;&quot;</span>
                <span class="c1"># Limit the number of concurrent tasks to prevent resource exhaustion</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_model(</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">) - starting&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># TODO: how to add timeout here? Probably best to timeout model loading?</span>
                        <span class="n">model_add</span><span class="p">(</span>
                            <span class="n">AddModelRequest</span><span class="p">(</span>
                                <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                                <span class="n">model_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> loaded successfully.&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error loading model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                            <span class="n">state</span><span class="o">.</span><span class="n">initialization_errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_model(</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">) - finished&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">PRELOAD_MODELS</span><span class="p">:</span>
                    <span class="c1"># Create tasks for each model to be loaded</span>
                    <span class="n">model_loading_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">loaded_futures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Future</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">PRELOAD_MODELS</span><span class="p">:</span>
                        <span class="n">future</span> <span class="o">=</span> <span class="n">model_loading_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                            <span class="n">load_model</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span>
                        <span class="p">)</span>
                        <span class="n">loaded_futures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">loaded_futures</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span>
                            <span class="ne">TimeoutError</span><span class="p">,</span>
                            <span class="n">CancelledError</span><span class="p">,</span>
                            <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="n">state</span><span class="o">.</span><span class="n">initialization_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">model_id</span><span class="p">,</span>
                                    <span class="s2">&quot;Could not finalise model loading before timeout&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                <span class="c1"># Update the readiness state in a thread-safe manner</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">startup_model_init</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Initialize the models on startup.&quot;&quot;&quot;</span>
                <span class="n">startup_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">initialize_models</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model_init_state</span><span class="p">,),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">startup_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model initialization started in the background.&quot;</span><span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/readiness&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">readiness</span><span class="p">(</span>
                <span class="n">state</span><span class="p">:</span> <span class="n">ModelInitState</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">model_init_state</span><span class="p">),</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Readiness endpoint for Kubernetes readiness probe.&quot;&quot;&quot;</span>
                <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_ready</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ready&quot;</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                            <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not ready&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">503</span>
                        <span class="p">)</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/healthz&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">healthz</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Health endpoint for Kubernetes liveness probe.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">CORE_MODELS_ENABLED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CORE_MODEL_CLIP_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/clip/embed_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ClipEmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Image Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to embed image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">clip_embed_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipImageEmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the OpenAI CLIP model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (ClipImageEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        ClipEmbeddingResponse: The response containing the embedded image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/embed_image&quot;</span><span class="p">)</span>
                    <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/clip/embed_text&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ClipEmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Text Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to embed text data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">clip_embed_text</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipTextEmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds text data using the OpenAI CLIP model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (ClipTextEmbeddingRequest): The request containing the text to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        ClipEmbeddingResponse: The response containing the embedded text.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/embed_text&quot;</span><span class="p">)</span>
                    <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/clip/compare&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ClipCompareResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Compare&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to compute similarity scores.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">clip_compare</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipCompareRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Computes similarity scores using the OpenAI CLIP model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (ClipCompareRequest): The request containing the data to be compared.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        ClipCompareResponse: The response containing the similarity scores.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/compare&quot;</span><span class="p">)</span>
                    <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_PE_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/perception_encoder/embed_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderEmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;PE Image Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to embed image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">pe_embed_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderImageEmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the Perception Encoder PE model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (PerceptionEncoderImageEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        PerceptionEncoderEmbeddingResponse: The response containing the embedded image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/embed_image&quot;</span><span class="p">)</span>
                    <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/perception_encoder/embed_text&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderEmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Perception Encoder Text Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to embed text data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">pe_embed_text</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderTextEmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds text data using the Meta Perception Encoder model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (PerceptionEncoderTextEmbeddingRequest): The request containing the text to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        PerceptionEncoderEmbeddingResponse: The response containing the embedded text.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/embed_text&quot;</span><span class="p">)</span>
                    <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/perception_encoder/compare&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderCompareResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Perception Encoder Compare&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to compute similarity scores.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">pe_compare</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderCompareRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Computes similarity scores using the Meta Perception Encoder model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (PerceptionEncoderCompareRequest): The request containing the data to be compared.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        PerceptionEncoderCompareResponse: The response containing the similarity scores.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/compare&quot;</span><span class="p">)</span>
                    <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_GROUNDINGDINO_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/grounding_dino/infer&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Grounding DINO inference.&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Grounding DINO zero-shot object detection model.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">grounding_dino_infer</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">GroundingDINOInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the Grounding DINO model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request GroundingDINOInferenceRequest): The request containing the image on which to run object detection.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        ObjectDetectionInferenceResponse: The object detection response.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /grounding_dino/infer&quot;</span><span class="p">)</span>
                    <span class="n">grounding_dino_model_id</span> <span class="o">=</span> <span class="n">load_grounding_dino_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">grounding_dino_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">grounding_dino_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_YOLO_WORLD_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/yolo_world/infer&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;YOLO-World inference.&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the YOLO-World zero-shot object detection model.&quot;</span><span class="p">,</span>
                    <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">yolo_world_infer</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">YOLOWorldInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Runs the YOLO-World zero-shot object detection model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (YOLOWorldInferenceRequest): The request containing the image on which to run object detection.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        ObjectDetectionInferenceResponse: The object detection response.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /yolo_world/infer. Loading model&quot;</span><span class="p">)</span>
                    <span class="n">yolo_world_model_id</span> <span class="o">=</span> <span class="n">load_yolo_world_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;YOLOWorld model loaded. Staring the inference.&quot;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">yolo_world_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;YOLOWorld prediction available.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">yolo_world_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Usage of YOLOWorld denoted.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_DOCTR_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/doctr/ocr&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                        <span class="n">OCRInferenceResponse</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OCRInferenceResponse</span><span class="p">]</span>
                    <span class="p">],</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;DocTR OCR response&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the DocTR OCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">doctr_retrieve_text</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">DoctrOCRInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the DocTR model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (M.DoctrOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        OCRInferenceResponse: The response containing the embedded image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /doctr/ocr&quot;</span><span class="p">)</span>
                    <span class="n">doctr_model_id</span> <span class="o">=</span> <span class="n">load_doctr_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">doctr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">doctr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_EASYOCR_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/easy_ocr/ocr&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                        <span class="n">OCRInferenceResponse</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OCRInferenceResponse</span><span class="p">]</span>
                    <span class="p">],</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;EasyOCR OCR response&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the EasyOCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">easy_ocr_retrieve_text</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">EasyOCRInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the EasyOCR model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (EasyOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        OCRInferenceResponse: The response containing the embedded image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /easy_ocr/ocr&quot;</span><span class="p">)</span>
                    <span class="n">easy_ocr_model_id</span> <span class="o">=</span> <span class="n">load_easy_ocr_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">easy_ocr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">easy_ocr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_SAM_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/sam/embed_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">SamEmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM Image Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segmant Anything Model to embed image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">sam_embed_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">SamEmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.SamEmbeddingResponse or Response: The response containing the embedded image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam/embed_image&quot;</span><span class="p">)</span>
                    <span class="n">sam_model_id</span> <span class="o">=</span> <span class="n">load_sam_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">sam_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">sam_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                            <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">model_response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/sam/segment_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">SamSegmentationResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM Image Segmentation&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segmant Anything Model to generate segmenations for image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">sam_segment_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">SamSegmentationRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Generates segmentations for image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (SamSegmentationRequest): The request containing the image to be segmented.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.SamSegmentationResponse or Response: The response containing the segmented image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam/segment_image&quot;</span><span class="p">)</span>
                    <span class="n">sam_model_id</span> <span class="o">=</span> <span class="n">load_sam_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">sam_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">sam_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                            <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">model_response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_SAM2_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/sam2/embed_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">Sam2EmbeddingResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM2 Image Embeddings&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segment Anything 2 Model to embed image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">sam2_embed_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">Sam2EmbeddingRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the Meta AI Segment Anything Model (SAM).</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.Sam2EmbeddingResponse or Response: The response affirming the image has been embedded</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam2/embed_image&quot;</span><span class="p">)</span>
                    <span class="n">sam2_model_id</span> <span class="o">=</span> <span class="n">load_sam2_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">sam2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">model_response</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/sam2/segment_image&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">Sam2SegmentationResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM2 Image Segmentation&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segment Anything 2 Model to generate segmenations for image data.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">sam2_segment_image</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">Sam2SegmentationRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Generates segmentations for image data using the Meta AI Segment Anything Model (SAM).</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (Sam2SegmentationRequest): The request containing the image to be segmented.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.SamSegmentationResponse or Response: The response containing the segmented image.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam2/segment_image&quot;</span><span class="p">)</span>
                    <span class="n">sam2_model_id</span> <span class="o">=</span> <span class="n">load_sam2_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">sam2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                            <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">model_response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_OWLV2_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/owlv2/infer&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Owlv2 image prompting&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the google owlv2 model to few-shot object detect&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">owlv2_infer</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">OwlV2InferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Embeds image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.Sam2EmbeddingResponse or Response: The response affirming the image has been embedded</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /owlv2/infer&quot;</span><span class="p">)</span>
                    <span class="n">owl2_model_id</span> <span class="o">=</span> <span class="n">load_owlv2_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">owl2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">model_response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_GAZE_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/gaze/gaze_detection&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">GazeDetectionInferenceResponse</span><span class="p">],</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Gaze Detection&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the gaze detection model to detect gaze.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">gaze_detection</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">GazeDetectionInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Detect gaze using the gaze detection model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (M.GazeDetectionRequest): The request containing the image to be detected.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        M.GazeDetectionResponse: The response containing all the detected faces and the corresponding gazes.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /gaze/gaze_detection&quot;</span><span class="p">)</span>
                    <span class="n">gaze_model_id</span> <span class="o">=</span> <span class="n">load_gaze_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">gaze_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">gaze_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="n">DEPTH_ESTIMATION_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/infer/depth-estimation&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">DepthEstimationResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Depth Estimation&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the depth estimation model to generate a depth map.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">depth_estimation</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">DepthEstimationRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Generate a depth map using the depth estimation model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (DepthEstimationRequest): The request containing the image to estimate depth for.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        DepthEstimationResponse: The response containing the normalized depth map and optional visualization.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/depth-estimation&quot;</span><span class="p">)</span>
                    <span class="n">depth_model_id</span> <span class="o">=</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                        <span class="n">depth_model_id</span><span class="p">,</span>
                        <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">depth_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">depth_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>

                    <span class="c1"># Extract data from nested response structure</span>
                    <span class="n">depth_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">response</span>
                    <span class="n">depth_response</span> <span class="o">=</span> <span class="n">DepthEstimationResponse</span><span class="p">(</span>
                        <span class="n">normalized_depth</span><span class="o">=</span><span class="n">depth_data</span><span class="p">[</span><span class="s2">&quot;normalized_depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="n">image</span><span class="o">=</span><span class="n">depth_data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy_image</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">depth_response</span>

            <span class="k">if</span> <span class="n">CORE_MODEL_TROCR_ENABLED</span><span class="p">:</span>

                <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="s2">&quot;/ocr/trocr&quot;</span><span class="p">,</span>
                    <span class="n">response_model</span><span class="o">=</span><span class="n">OCRInferenceResponse</span><span class="p">,</span>
                    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;TrOCR OCR response&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the TrOCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nd">@with_route_exceptions</span>
                <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">trocr_retrieve_text</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">:</span> <span class="n">TrOCRInferenceRequest</span><span class="p">,</span>
                    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Retrieves text from image data using the TrOCR model.</span>

<span class="sd">                    Args:</span>
<span class="sd">                        inference_request (TrOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                        api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                        request (Request, default Body()): The HTTP request.</span>

<span class="sd">                    Returns:</span>
<span class="sd">                        OCRInferenceResponse: The response containing the retrieved text.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /trocr/ocr&quot;</span><span class="p">)</span>
                    <span class="n">trocr_model_id</span> <span class="o">=</span> <span class="n">load_trocr_model</span><span class="p">(</span>
                        <span class="n">inference_request</span><span class="p">,</span>
                        <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                        <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                        <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                        <span class="n">trocr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                        <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;authorizer&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">trocr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/notebook/start&quot;</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Jupyter Lab Server Start&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Starts a jupyter lab server for running development code&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">notebook_start</span><span class="p">(</span><span class="n">browserless</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Starts a jupyter lab server for running development code.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (NotebookStartRequest): The request containing the necessary details for starting a jupyter lab server.</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                Returns:</span>
<span class="sd">                    NotebookStartResponse: The response containing the URL of the jupyter lab server.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /notebook/start&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">NOTEBOOK_ENABLED</span><span class="p">:</span>
                    <span class="n">start_notebook</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">browserless</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span>
                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Jupyter Lab server started at http://localhost:</span><span class="si">{</span><span class="n">NOTEBOOK_PORT</span><span class="si">}</span><span class="s2">?token=</span><span class="si">{</span><span class="n">NOTEBOOK_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;http://localhost:</span><span class="si">{</span><span class="n">NOTEBOOK_PORT</span><span class="si">}</span><span class="s2">/lab/tree/quickstart.ipynb?token=</span><span class="si">{</span><span class="n">NOTEBOOK_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">browserless</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span>
                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Notebook server is not enabled. Enable notebooks via the NOTEBOOK_ENABLED environment variable.&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/notebook-instructions.html&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ENABLE_BUILDER</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.interfaces.http.builder.routes</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">router</span> <span class="k">as</span> <span class="n">builder_router</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Allow CORS on only the API, but not the builder UI/iframe (where the CSRF is passed)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
                <span class="n">PathAwareCORSMiddleware</span><span class="p">,</span>
                <span class="n">match_paths</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^/build/api.*&quot;</span><span class="p">,</span>
                <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="n">BUILDER_ORIGIN</span><span class="p">],</span>
                <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
                <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
                <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Attach all routes from builder to the /build prefix</span>
            <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">builder_router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/build&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;builder&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">LEGACY_ROUTE_ENABLED</span><span class="p">:</span>
            <span class="c1"># Legacy object detection inference path for backwards compatibility</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;/</span><span class="si">{dataset_id}</span><span class="s2">/{version_id:str}&quot;</span><span class="p">,</span>
                <span class="c1"># Order matters in this response model Union. It will use the first matching model. For example, Object Detection Inference Response is a subset of Instance segmentation inference response, so instance segmentation must come first in order for the matching logic to work.</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span>
                    <span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">StubResponse</span><span class="p">,</span>
                    <span class="n">Any</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/</span><span class="si">{dataset_id}</span><span class="s2">/{version_id:str}&quot;</span><span class="p">,</span>
                <span class="c1"># Order matters in this response model Union. It will use the first matching model. For example, Object Detection Inference Response is a subset of Instance segmentation inference response, so instance segmentation must come first in order for the matching logic to work.</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span>
                    <span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                    <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                    <span class="n">StubResponse</span><span class="p">,</span>
                    <span class="n">Any</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">legacy_infer_from_request</span><span class="p">(</span>
                <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">request_body</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
                    <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">UploadFile</span><span class="p">]],</span>
                    <span class="n">Depends</span><span class="p">(</span><span class="n">parse_body_content_for_legacy_request_handler</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ID of a Roboflow dataset corresponding to the model to use for inference OR workspace ID&quot;</span>
                <span class="p">),</span>
                <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ID of a Roboflow dataset version corresponding to the model to use for inference OR model ID&quot;</span>
                <span class="p">),</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mf">0.4</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The confidence threshold used to filter out predictions&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">keypoint_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The confidence threshold used to filter out keypoints that are not visible based on model confidence&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="s2">&quot;json&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of &#39;json&#39; or &#39;image&#39;. If &#39;json&#39; prediction data is return as a JSON string. If &#39;image&#39; prediction data is visualized and overlayed on the original input image.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The publically accessible URL of an image to use for inference.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">image_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="s2">&quot;base64&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of base64 or numpy. Note, numpy input is not supported for Roboflow Hosted Inference.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, labels will be include in any inference visualization.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">mask_decode_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="s2">&quot;accurate&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of &#39;accurate&#39; or &#39;fast&#39;. If &#39;accurate&#39; the mask will be decoded using the original image size. If &#39;fast&#39; the mask will be decoded using the original mask size. &#39;accurate&#39; is slower but more accurate.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">tradeoff_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The amount to tradeoff between 0=&#39;fast&#39; and 1=&#39;accurate&#39;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">max_detections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mi">300</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The maximum number of detections to return. This is used to limit the number of predictions returned by the model. The model may return more predictions than this number, but only the top `max_detections` predictions will be returned.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The IoU threhsold that must be met for a box pair to be considered duplicate during NMS&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">stroke</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The stroke width used when visualizing predictions&quot;</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If false, does not track inference against usage.&quot;</span><span class="p">,</span>
                    <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Shared secret used to authenticate requests to the inference server from internal services (e.g. to allow disabling inference usage tracking via the `countinference` query parameter)&quot;</span><span class="p">,</span>
                    <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">disable_preproc_auto_orient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic image orientation&quot;</span>
                <span class="p">),</span>
                <span class="n">disable_preproc_contrast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic contrast adjustment&quot;</span>
                <span class="p">),</span>
                <span class="n">disable_preproc_grayscale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic grayscale conversion&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">disable_preproc_static_crop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic static crop&quot;</span>
                <span class="p">),</span>
                <span class="n">disable_active_learning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, the predictions will be prevented from registration by Active Learning (if the functionality is enabled)&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">active_learning_target_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parameter to be used when Active Learning data registration should happen against different dataset than the one pointed by model_id&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="s2">&quot;external&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The source of the inference request&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">source_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="s2">&quot;external&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The detailed source information of the inference request&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">disable_model_monitoring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables model monitoring for this request&quot;</span><span class="p">,</span>
                    <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Legacy inference endpoint for object detection, instance segmentation, and classification.</span>

<span class="sd">                Args:</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>
<span class="sd">                    dataset_id (str): ID of a Roboflow dataset corresponding to the model to use for inference OR workspace ID</span>
<span class="sd">                    version_id (str): ID of a Roboflow dataset version corresponding to the model to use for inference OR model ID</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    # Other parameters described in the function signature...</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Union[InstanceSegmentationInferenceResponse, KeypointsDetectionInferenceRequest, ObjectDetectionInferenceResponse, ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse, Any]: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reached legacy route /:dataset_id/:version_id with </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">confidence</span> <span class="o">/=</span> <span class="mi">100</span>
                <span class="k">elif</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">CONFIDENCE_LOWER_BOUND_OOM_PREVENTION</span><span class="p">:</span>
                    <span class="c1"># allowing lower confidence results in RAM usage explosion</span>
                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">CONFIDENCE_LOWER_BOUND_OOM_PREVENTION</span>

                <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">overlap</span> <span class="o">/=</span> <span class="mi">100</span>
                <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ContentTypeMissing</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Request must include a Content-Type header&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="n">UploadFile</span><span class="p">):</span>
                        <span class="n">base64_image_str</span> <span class="o">=</span> <span class="n">request_body</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">base64_image_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">base64_image_str</span><span class="p">)</span>
                        <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;base64&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">base64_image_str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">image_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">request_body</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">request_body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputImageLoadError</span><span class="p">(</span>
                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Image not found in request body.&quot;</span><span class="p">,</span>
                            <span class="n">public_message</span><span class="o">=</span><span class="s2">&quot;Image not found in request body.&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ContentTypeInvalid</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid Content-Type: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">countinference</span> <span class="ow">and</span> <span class="n">service_secret</span> <span class="o">!=</span> <span class="n">ROBOFLOW_SERVICE_SECRET</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MissingServiceSecretError</span><span class="p">(</span>
                        <span class="s2">&quot;Service secret is required to disable inference usage tracking&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request.scope: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
                    <span class="n">request_model_id</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span><span class="s2">&quot;authorizer&quot;</span><span class="p">][</span>
                            <span class="s2">&quot;lambda&quot;</span>
                        <span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;endpoint&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rf-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;nu-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span><span class="s2">&quot;authorizer&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;lambda&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">countinference</span><span class="p">:</span>
                        <span class="n">trackUsage</span><span class="p">(</span><span class="n">request_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">service_secret</span> <span class="o">!=</span> <span class="n">ROBOFLOW_SERVICE_SECRET</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MissingServiceSecretError</span><span class="p">(</span>
                                <span class="s2">&quot;Service secret is required to disable inference usage tracking&quot;</span>
                            <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not counting inference for usage&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">request_model_id</span> <span class="o">=</span> <span class="n">model_id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;State of model registry: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                    <span class="n">request_model_id</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">,</span>
                    <span class="n">model_id_alias</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">get_task_type</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">ObjectDetectionInferenceRequest</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;instance-segmentation&quot;</span><span class="p">:</span>
                    <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">InstanceSegmentationInferenceRequest</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;mask_decode_mode&quot;</span><span class="p">:</span> <span class="n">mask_decode_mode</span><span class="p">,</span>
                        <span class="s2">&quot;tradeoff_factor&quot;</span><span class="p">:</span> <span class="n">tradeoff_factor</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
                    <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">ClassificationInferenceRequest</span>
                <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;keypoint-detection&quot;</span><span class="p">:</span>
                    <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">KeypointsDetectionInferenceRequest</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keypoint_confidence&quot;</span><span class="p">:</span> <span class="n">keypoint_confidence</span><span class="p">}</span>
                <span class="n">inference_request</span> <span class="o">=</span> <span class="n">inference_request_type</span><span class="p">(</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">request_image</span><span class="p">,</span>
                    <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
                    <span class="n">iou_threshold</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                    <span class="n">max_detections</span><span class="o">=</span><span class="n">max_detections</span><span class="p">,</span>
                    <span class="n">visualization_labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                    <span class="n">visualization_stroke_width</span><span class="o">=</span><span class="n">stroke</span><span class="p">,</span>
                    <span class="n">visualize_predictions</span><span class="o">=</span><span class="p">(</span>
                        <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">or</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image_and_json&quot;</span>
                    <span class="p">),</span>
                    <span class="n">disable_preproc_auto_orient</span><span class="o">=</span><span class="n">disable_preproc_auto_orient</span><span class="p">,</span>
                    <span class="n">disable_preproc_contrast</span><span class="o">=</span><span class="n">disable_preproc_contrast</span><span class="p">,</span>
                    <span class="n">disable_preproc_grayscale</span><span class="o">=</span><span class="n">disable_preproc_grayscale</span><span class="p">,</span>
                    <span class="n">disable_preproc_static_crop</span><span class="o">=</span><span class="n">disable_preproc_static_crop</span><span class="p">,</span>
                    <span class="n">disable_active_learning</span><span class="o">=</span><span class="n">disable_active_learning</span><span class="p">,</span>
                    <span class="n">active_learning_target_dataset</span><span class="o">=</span><span class="n">active_learning_target_dataset</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">source_info</span><span class="o">=</span><span class="n">source_info</span><span class="p">,</span>
                    <span class="n">usage_billable</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">disable_model_monitoring</span><span class="o">=</span><span class="n">disable_model_monitoring</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">args</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">inference_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response ready.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">inference_response</span><span class="o">.</span><span class="n">visualization</span><span class="p">,</span>
                        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">inference_response</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>
            <span class="c1"># Legacy clear cache endpoint for backwards compatibility</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/clear_cache&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">legacy_clear_cache</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Clears the model cache.</span>

<span class="sd">                This endpoint provides a way to clear the cache of loaded models.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    str: A string indicating that the cache has been cleared.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clear_cache&quot;</span><span class="p">)</span>
                <span class="n">model_clear</span><span class="p">()</span>
                <span class="k">return</span> <span class="s2">&quot;Cache Cleared&quot;</span>

            <span class="c1"># Legacy add model endpoint for backwards compatibility</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/start/</span><span class="si">{dataset_id}</span><span class="s2">/</span><span class="si">{version_id}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">model_add_legacy</span><span class="p">(</span>
                <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Starts a model inference session.</span>

<span class="sd">                This endpoint initializes and starts an inference session for the specified model version.</span>

<span class="sd">                Args:</span>
<span class="sd">                    dataset_id (str): ID of a Roboflow dataset corresponding to the model.</span>
<span class="sd">                    version_id (str): ID of a Roboflow dataset version corresponding to the model.</span>
<span class="sd">                    api_key (str, optional): Roboflow API Key for artifact retrieval.</span>
<span class="sd">                    countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">                    service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    JSONResponse: A response object containing the status and a success message.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reached /start/</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;inference session started from local memory.&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ENABLE_DASHBOARD</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/dashboard.html&quot;</span><span class="p">)</span>
            <span class="nd">@app</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="s2">&quot;/dashboard.html&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dashboard_guard</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">InputImageLoadError</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unicorn_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">InputImageLoadError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Could not load input image. Cause: </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="n">get_public_error_details</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
            <span class="s2">&quot;/&quot;</span><span class="p">,</span>
            <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="inference.core.interfaces.http.http_api.HttpInterface.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">root_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#inference.core.interfaces.http.http_api.HttpInterface.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initializes the HttpInterface with given model manager and model registry.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" href="../../../managers/base/#inference.core.managers.base.ModelManager">ModelManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The manager for handling different models.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>root_path</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The root path for the FastAPI application.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="description" open>
  <summary>Description</summary>
  <p>Deploy Roboflow trained models to nearly any compute environment!</p>
</details>

            <details class="quote">
              <summary>Source code in <code>inference/core/interfaces/http/http_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_manager</span><span class="p">:</span> <span class="n">ModelManager</span><span class="p">,</span>
    <span class="n">root_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the HttpInterface with given model manager and model registry.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_manager (ModelManager): The manager for handling different models.</span>
<span class="sd">        root_path (Optional[str]): The root path for the FastAPI application.</span>

<span class="sd">    Description:</span>
<span class="sd">        Deploy Roboflow trained models to nearly any compute environment!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Roboflow inference server&quot;</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Roboflow Inference Server&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
        <span class="n">terms_of_service</span><span class="o">=</span><span class="s2">&quot;https://roboflow.com/terms&quot;</span><span class="p">,</span>
        <span class="n">contact</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Roboflow Inc.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://roboflow.com/contact&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;help@roboflow.com&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">license_info</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Apache 2.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">root_path</span><span class="o">=</span><span class="n">root_path</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Ensure in-memory logging is initialized as early as possible for all runtimes</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.logging.memory_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_memory_logging</span>

        <span class="n">setup_memory_logging</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
        <span class="s2">&quot;/static&quot;</span><span class="p">,</span>
        <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out/static&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
        <span class="s2">&quot;/_next/static&quot;</span><span class="p">,</span>
        <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out/_next/static&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_next_static&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;shutdown&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_shutdown</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">usage_collector</span><span class="o">.</span><span class="n">async_push_usage_payloads</span><span class="p">()</span>

    <span class="n">InferenceInstrumentator</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">LambdaMiddleware</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">GCPServerlessMiddleware</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ALLOW_ORIGINS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Add CORS Middleware (but not for /build**, which is controlled separately)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
            <span class="n">PathAwareCORSMiddleware</span><span class="p">,</span>
            <span class="n">match_paths</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^(?!/build).*&quot;</span><span class="p">,</span>
            <span class="n">allow_origins</span><span class="o">=</span><span class="n">ALLOW_ORIGINS</span><span class="p">,</span>
            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="n">expose_headers</span><span class="o">=</span><span class="p">[</span><span class="n">PROCESSING_TIME_HEADER</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="c1"># Optionally add middleware for profiling the FastAPI server and underlying inference API code</span>
    <span class="k">if</span> <span class="n">PROFILE</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
            <span class="n">CProfileMiddleware</span><span class="p">,</span>
            <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">server_app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;/profile/output.pstats&quot;</span><span class="p">,</span>
            <span class="n">strip_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;cumulative&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">API_LOGGING_ENABLED</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
            <span class="n">asgi_correlation_id</span><span class="o">.</span><span class="n">CorrelationIdMiddleware</span><span class="p">,</span>
            <span class="n">header_name</span><span class="o">=</span><span class="n">CORRELATION_ID_HEADER</span><span class="p">,</span>
            <span class="n">update_request_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">transformer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">asgi_correlation_id</span><span class="o">.</span><span class="n">CorrelationIdMiddleware</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">METRICS_ENABLED</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">count_errors</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Middleware to count errors.</span>

<span class="sd">            Args:</span>
<span class="sd">                request (Request): The incoming request.</span>
<span class="sd">                call_next (Callable): The next middleware or endpoint to call.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Response: The response from the next middleware or endpoint.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">pingback</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">num_errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/device/stats&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">device_stats</span><span class="p">():</span>
            <span class="n">not_configured_error_message</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Device statistics endpoint is not enabled.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Mount the Docker socket and point its location when running the docker &quot;</span>
                <span class="s2">&quot;container to collect device stats &quot;</span>
                <span class="s2">&quot;(i.e. `docker run ... -v /var/run/docker.sock:/var/run/docker.sock &quot;</span>
                <span class="s2">&quot;-e DOCKER_SOCKET_PATH=/var/run/docker.sock ...`).&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCKER_SOCKET_PATH</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">not_configured_error_message</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_docker_socket_mounted</span><span class="p">(</span><span class="n">docker_socket_path</span><span class="o">=</span><span class="n">DOCKER_SOCKET_PATH</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">not_configured_error_message</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">container_stats</span> <span class="o">=</span> <span class="n">get_container_stats</span><span class="p">(</span>
                <span class="n">docker_socket_path</span><span class="o">=</span><span class="n">DOCKER_SOCKET_PATH</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">container_stats</span><span class="p">)</span>

    <span class="n">cached_api_keys</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_authorization_serverless</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
            <span class="c1"># exclusions</span>
            <span class="n">skip_check</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
                <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/healthz&quot;</span><span class="p">,</span>  <span class="c1"># health check endpoint for liveness probe</span>
                    <span class="s2">&quot;/readiness&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/metrics&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>  <span class="c1"># needed for /docs and /redoc</span>
                    <span class="s2">&quot;/model/registry&quot;</span><span class="p">,</span>  <span class="c1"># dont auth this route, usually not used on serverlerless, but queue based serverless uses it internally (not accessible from outside)</span>
                <span class="p">]</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/static/&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/_next/&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># for these routes we only want to auth if dynamic python modules are provided</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/workflows/definition/schema&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                    <span class="n">skip_check</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                    <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;dynamic_blocks_definitions&quot;</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamic_blocks_definitions</span><span class="p">:</span>
                        <span class="n">skip_check</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">skip_check</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_unauthorized_response</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="n">req_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>
            <span class="n">json_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">req_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># have to try catch here, because some legacy endpoints that abuse Content-Type header but dont actually receive json</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cached_api_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">get_roboflow_workspace_async</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
                    <span class="n">cached_api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span>
                    <span class="p">)</span>  <span class="c1"># expired after 1 hour</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span> <span class="n">WorkspaceLoadError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_authorization</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
            <span class="c1"># exclusions</span>
            <span class="n">skip_check</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
                <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/healthz&quot;</span><span class="p">,</span>  <span class="c1"># health check endpoint for liveness probe</span>
                    <span class="s2">&quot;/readiness&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/metrics&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>  <span class="c1"># needed for /docs and /redoc</span>
                <span class="p">]</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/static/&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/_next/&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_check</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_unauthorized_response</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># check api_key</span>
            <span class="n">req_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>
            <span class="n">json_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">req_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">get_content_type</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span>
                <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># have to try catch here, because some legacy endpoints that abuse Content-Type header but dont actually receive json</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json_params</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">json_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cached_api_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># TODO: make this request async!</span>
                    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">workspace_url</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">workspace_url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_roboflow_workspace_async</span><span class="p">(</span>
                            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">workspace_url</span> <span class="o">!=</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

                    <span class="n">cached_api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span>
                    <span class="p">)</span>  <span class="c1"># expired after 1 hour</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span> <span class="n">WorkspaceLoadError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">_unauthorized_response</span><span class="p">(</span><span class="s2">&quot;Unauthorized api_key&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span> <span class="o">=</span> <span class="n">model_manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StreamManagerClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">ENABLE_STREAM_API</span><span class="p">:</span>
        <span class="n">operations_timeout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_OPERATIONS_TIMEOUT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operations_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operations_timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">operations_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span> <span class="o">=</span> <span class="n">StreamManagerClient</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">),</span>
            <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STREAM_MANAGER_PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;7070&quot;</span><span class="p">)),</span>
            <span class="n">operations_timeout</span><span class="o">=</span><span class="n">operations_timeout</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_inference_request</span><span class="p">(</span>
        <span class="n">inference_request</span><span class="p">:</span> <span class="n">InferenceRequest</span><span class="p">,</span>
        <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes an inference request by calling the appropriate model.</span>

<span class="sd">        Args:</span>
<span class="sd">            inference_request (InferenceRequest): The request containing model ID and other inference details.</span>
<span class="sd">            countinference (Optional[bool]): Whether to count inference for usage.</span>
<span class="sd">            service_secret (Optional[str]): The service secret.</span>

<span class="sd">        Returns:</span>
<span class="sd">            InferenceResponse: The response containing the inference results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
            <span class="n">model_id</span><span class="o">=</span><span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
            <span class="n">de_aliased_model_id</span><span class="p">,</span>
            <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
            <span class="n">de_aliased_model_id</span><span class="p">,</span> <span class="n">inference_request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_workflow_inference_request</span><span class="p">(</span>
        <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowInferenceRequest</span><span class="p">,</span>
        <span class="n">workflow_specification</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">background_tasks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BackgroundTasks</span><span class="p">],</span>
        <span class="n">profiler</span><span class="p">:</span> <span class="n">WorkflowsProfiler</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>

        <span class="n">workflow_init_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;workflows_core.model_manager&quot;</span><span class="p">:</span> <span class="n">model_manager</span><span class="p">,</span>
            <span class="s2">&quot;workflows_core.api_key&quot;</span><span class="p">:</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
            <span class="s2">&quot;workflows_core.background_tasks&quot;</span><span class="p">:</span> <span class="n">background_tasks</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">execution_engine</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
            <span class="n">workflow_definition</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
            <span class="n">init_parameters</span><span class="o">=</span><span class="n">workflow_init_parameters</span><span class="p">,</span>
            <span class="n">max_concurrent_steps</span><span class="o">=</span><span class="n">WORKFLOWS_MAX_CONCURRENT_STEPS</span><span class="p">,</span>
            <span class="n">prevent_local_images_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
            <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">is_preview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">workflow_request</span><span class="p">,</span> <span class="s2">&quot;is_preview&quot;</span><span class="p">):</span>
            <span class="n">is_preview</span> <span class="o">=</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">is_preview</span>
        <span class="n">workflow_results</span> <span class="o">=</span> <span class="n">execution_engine</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">runtime_parameters</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">serialize_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">_is_preview</span><span class="o">=</span><span class="n">is_preview</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">profile_execution_phase</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workflow_results_filtering&quot;</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inference_package_operation&quot;</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">filter_out_unwanted_workflow_outputs</span><span class="p">(</span>
                <span class="n">workflow_results</span><span class="o">=</span><span class="n">workflow_results</span><span class="p">,</span>
                <span class="n">excluded_fields</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">excluded_fields</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">profiler_trace</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">export_trace</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">WorkflowInferenceResponse</span><span class="p">(</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
            <span class="n">profiler_trace</span><span class="o">=</span><span class="n">profiler_trace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_core_model</span><span class="p">(</span>
        <span class="n">inference_request</span><span class="p">:</span> <span class="n">InferenceRequest</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">core_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a core model (e.g., &quot;clip&quot; or &quot;sam&quot;) into the model manager.</span>

<span class="sd">        Args:</span>
<span class="sd">            inference_request (InferenceRequest): The request containing version and other details.</span>
<span class="sd">            api_key (Optional[str]): The API key for the request.</span>
<span class="sd">            core_model (str): The core model type, e.g., &quot;clip&quot; or &quot;sam&quot;.</span>
<span class="sd">            countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">            service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The core model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">version_id_field</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_model</span><span class="si">}</span><span class="s2">_version_id&quot;</span>
        <span class="n">core_model_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_model</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">inference_request</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">version_id_field</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
            <span class="n">core_model_id</span><span class="p">,</span>
            <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
            <span class="n">endpoint_type</span><span class="o">=</span><span class="n">ModelEndpointType</span><span class="o">.</span><span class="n">CORE_MODEL</span><span class="p">,</span>
            <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">core_model_id</span>

    <span class="n">load_clip_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the CLIP model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The CLIP model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_pe_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;perception_encoder&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the Perception Encoder model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The Perception Encoder model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_sam_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;sam&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the SAM model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The SAM model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">load_sam2_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;sam2&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the SAM2 model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The SAM2 model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_gaze_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;gaze&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the GAZE model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The GAZE model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_doctr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;doctr&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the DocTR model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The DocTR model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_easy_ocr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;easy_ocr&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the EasyOCR model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The EasyOCR model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_paligemma_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;paligemma&quot;</span><span class="p">)</span>

    <span class="n">load_grounding_dino_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;grounding_dino&quot;</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the Grounding DINO model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The Grounding DINO model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_yolo_world_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;yolo_world&quot;</span><span class="p">)</span>
    <span class="n">load_owlv2_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;owlv2&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the YOLO World model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The YOLO World model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">load_trocr_model</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">load_core_model</span><span class="p">,</span> <span class="n">core_model</span><span class="o">=</span><span class="s2">&quot;trocr&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the TrOCR model into the model manager.</span>

<span class="sd">    Args:</span>
<span class="sd">    Same as `load_core_model`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    The TrOCR model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;/info&quot;</span><span class="p">,</span>
        <span class="n">response_model</span><span class="o">=</span><span class="n">ServerVersionInfo</span><span class="p">,</span>
        <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Info&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get the server name and version number&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Endpoint to get the server name and version number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ServerVersionInfo: The server version information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ServerVersionInfo</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Roboflow Inference Server&quot;</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">GLOBAL_INFERENCE_SERVER_ID</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;/logs&quot;</span><span class="p">,</span>
        <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Get Recent Logs&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get recent application logs for debugging&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_logs</span><span class="p">(</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
            <span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of log entries to return&quot;</span>
        <span class="p">),</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filter by log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">since</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Return logs since this ISO timestamp&quot;</span>
        <span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent application logs from memory.</span>

<span class="sd">        Only available when ENABLE_IN_MEMORY_LOGS environment variable is set to &#39;true&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            limit: Maximum number of log entries (default 100)</span>
<span class="sd">            level: Filter by log level</span>
<span class="sd">            since: ISO timestamp to filter logs since</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of log entries with timestamp, level, logger, and message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if in-memory logging is enabled</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.logging.memory_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">get_recent_logs</span><span class="p">,</span>
            <span class="n">is_memory_logging_enabled</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_memory_logging_enabled</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Logs endpoint not available&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="n">get_recent_logs</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="ow">or</span> <span class="mi">100</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">logs</span><span class="p">,</span> <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Logging system not properly initialized&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">LAMBDA</span> <span class="ow">and</span> <span class="n">GET_MODEL_REGISTRY_ENABLED</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/model/registry&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Get model keys&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get the ID of each loaded model&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">registry</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the ID of each loaded model in the registry.</span>

<span class="sd">            Returns:</span>
<span class="sd">                ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/registry&quot;</span><span class="p">)</span>
            <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
            <span class="p">)</span>

    <span class="c1"># The current AWS Lambda authorizer only supports path parameters, therefore we can only use the legacy infer route. This case statement excludes routes which won&#39;t work for the current Lambda authorizer.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/model/add&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Load a model&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Load the model with the given model ID&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">model_add</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">AddModelRequest</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Load the model with the given model ID into the model manager.</span>

<span class="sd">            Args:</span>
<span class="sd">                request (AddModelRequest): The request containing the model ID and optional API key.</span>
<span class="sd">                countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">                service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">            Returns:</span>
<span class="sd">                ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/add&quot;</span><span class="p">)</span>
            <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_id</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading model: </span><span class="si">{</span><span class="n">de_aliased_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                <span class="n">de_aliased_model_id</span><span class="p">,</span>
                <span class="n">request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/model/remove&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Remove a model&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove the model with the given model ID&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">model_remove</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">ClearModelRequest</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Remove the model with the given model ID from the model manager.</span>

<span class="sd">            Args:</span>
<span class="sd">                request (ClearModelRequest): The request containing the model ID to be removed.</span>

<span class="sd">            Returns:</span>
<span class="sd">                ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/remove&quot;</span><span class="p">)</span>
            <span class="n">de_aliased_model_id</span> <span class="o">=</span> <span class="n">resolve_roboflow_model_alias</span><span class="p">(</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_id</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">de_aliased_model_id</span><span class="p">)</span>
            <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/model/clear&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ModelsDescriptions</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Remove all models&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove all loaded models&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">model_clear</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Remove all loaded models from the model manager.</span>

<span class="sd">            Returns:</span>
<span class="sd">                ModelsDescriptions: The object containing models descriptions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /model/clear&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">models_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ModelsDescriptions</span><span class="o">.</span><span class="n">from_models_descriptions</span><span class="p">(</span>
                <span class="n">models_descriptions</span><span class="o">=</span><span class="n">models_descriptions</span>
            <span class="p">)</span>

    <span class="c1"># these NEW endpoints need authentication protection</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LAMBDA</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">GCP_SERVERLESS</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/object_detection&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">List</span><span class="p">[</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">],</span>
                <span class="n">StubResponse</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Object detection infer&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified object detection model&quot;</span><span class="p">,</span>
            <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_object_detection</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">ObjectDetectionInferenceRequest</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Run inference with the specified object detection model.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (ObjectDetectionInferenceRequest): The request containing the necessary details for object detection.</span>
<span class="sd">                background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">            Returns:</span>
<span class="sd">                Union[ObjectDetectionInferenceResponse, List[ObjectDetectionInferenceResponse]]: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/object_detection&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">,</span>
                <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/instance_segmentation&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span> <span class="n">StubResponse</span>
            <span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Instance segmentation infer&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified instance segmentation model&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_instance_segmentation</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">InstanceSegmentationInferenceRequest</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Run inference with the specified instance segmentation model.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (InstanceSegmentationInferenceRequest): The request containing the necessary details for instance segmentation.</span>
<span class="sd">                background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">            Returns:</span>
<span class="sd">                InstanceSegmentationInferenceResponse: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/instance_segmentation&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">,</span>
                <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/classification&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">StubResponse</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Classification infer&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified classification model&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_classification</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClassificationInferenceRequest</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Run inference with the specified classification model.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (ClassificationInferenceRequest): The request containing the necessary details for classification.</span>
<span class="sd">                background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">            Returns:</span>
<span class="sd">                Union[ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse]: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/classification&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">,</span>
                <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/keypoints_detection&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span> <span class="n">StubResponse</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Keypoints detection infer&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified keypoints detection model&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_keypoints</span><span class="p">(</span>
            <span class="n">inference_request</span><span class="p">:</span> <span class="n">KeypointsDetectionInferenceRequest</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Run inference with the specified keypoints detection model.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (KeypointsDetectionInferenceRequest): The request containing the necessary details for keypoints detection.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Union[ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse]: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/keypoints_detection&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">LMM_ENABLED</span> <span class="ow">or</span> <span class="n">MOONDREAM2_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/lmm&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">LMMInferenceResponse</span><span class="p">,</span>
                    <span class="n">List</span><span class="p">[</span><span class="n">LMMInferenceResponse</span><span class="p">],</span>
                    <span class="n">StubResponse</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Large multi-modal model infer&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run inference with the specified large multi-modal model&quot;</span><span class="p">,</span>
                <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">infer_lmm</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">LMMInferenceRequest</span><span class="p">,</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Run inference with the specified object detection model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ObjectDetectionInferenceRequest): The request containing the necessary details for object detection.</span>
<span class="sd">                    background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">                Returns:</span>
<span class="sd">                    Union[ObjectDetectionInferenceResponse, List[ObjectDetectionInferenceResponse]]: The response containing the inference results.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/lmm&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">process_inference_request</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">DISABLE_WORKFLOW_ENDPOINTS</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/</span><span class="si">{workspace_name}</span><span class="s2">/workflows/</span><span class="si">{workflow_id}</span><span class="s2">/describe_interface&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">DescribeInterfaceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to describe interface of predefined workflow&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - describes workflow inputs and outputs&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">describe_predefined_workflow_interface</span><span class="p">(</span>
            <span class="n">workspace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">workflow_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">workflow_request</span><span class="p">:</span> <span class="n">PredefinedWorkflowDescribeInterfaceRequest</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DescribeInterfaceResponse</span><span class="p">:</span>
            <span class="n">workflow_specification</span> <span class="o">=</span> <span class="n">get_workflow_specification</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">workspace_id</span><span class="o">=</span><span class="n">workspace_name</span><span class="p">,</span>
                <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
                <span class="n">use_cache</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">handle_describe_workflows_interface</span><span class="p">(</span>
                <span class="n">definition</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/describe_interface&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">DescribeInterfaceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to describe interface of workflow given in request&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses workflow definition and retrieves describes inputs and outputs&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflow_interface</span><span class="p">(</span>
            <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowSpecificationDescribeInterfaceRequest</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DescribeInterfaceResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handle_describe_workflows_interface</span><span class="p">(</span>
                <span class="n">definition</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">specification</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/</span><span class="si">{workspace_name}</span><span class="s2">/workflows/</span><span class="si">{workflow_id}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to run predefined workflow&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - parses and executes injecting runtime parameters from request body&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/workflows/</span><span class="si">{workspace_name}</span><span class="s2">/</span><span class="si">{workflow_id}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to run predefined workflow&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks Roboflow API for workflow definition, once acquired - parses and executes injecting runtime parameters from request body. This endpoint is deprecated and will be removed end of Q2 2024&quot;</span><span class="p">,</span>
            <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_from_predefined_workflow</span><span class="p">(</span>
            <span class="n">workspace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">workflow_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">workflow_request</span><span class="p">:</span> <span class="n">PredefinedWorkflowInferenceRequest</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="k">if</span> <span class="n">ENABLE_WORKFLOWS_PROFILING</span> <span class="ow">and</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
                <span class="n">profiler</span> <span class="o">=</span> <span class="n">BaseWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                    <span class="n">max_runs_in_buffer</span><span class="o">=</span><span class="n">WORKFLOWS_PROFILER_BUFFER_SIZE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">profiler</span> <span class="o">=</span> <span class="n">NullWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">profiler</span><span class="o">.</span><span class="n">profile_execution_phase</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workflow_definition_fetching&quot;</span><span class="p">,</span>
                <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inference_package_operation&quot;</span><span class="p">],</span>
            <span class="p">):</span>
                <span class="n">workflow_specification</span> <span class="o">=</span> <span class="n">get_workflow_specification</span><span class="p">(</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">workspace_id</span><span class="o">=</span><span class="n">workspace_name</span><span class="p">,</span>
                    <span class="n">workflow_id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
                    <span class="n">use_cache</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span><span class="p">:</span>
                <span class="n">workflow_request</span><span class="o">.</span><span class="n">workflow_id</span> <span class="o">=</span> <span class="n">workflow_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_specification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Internal workflow ID missing in specification for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">workflow_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">process_workflow_inference_request</span><span class="p">(</span>
                <span class="n">workflow_request</span><span class="o">=</span><span class="n">workflow_request</span><span class="p">,</span>
                <span class="n">workflow_specification</span><span class="o">=</span><span class="n">workflow_specification</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">background_tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/run&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to run workflow specification provided in payload&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses and executes workflow specification, injecting runtime parameters from request body.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/infer/workflows&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowInferenceResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to run workflow specification provided in payload&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parses and executes workflow specification, injecting runtime parameters from request body. This endpoint is deprecated and will be removed end of Q2 2024.&quot;</span><span class="p">,</span>
            <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">infer_from_workflow</span><span class="p">(</span>
            <span class="n">workflow_request</span><span class="p">:</span> <span class="n">WorkflowSpecificationInferenceRequest</span><span class="p">,</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowInferenceResponse</span><span class="p">:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="k">if</span> <span class="n">ENABLE_WORKFLOWS_PROFILING</span> <span class="ow">and</span> <span class="n">workflow_request</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">:</span>
                <span class="n">profiler</span> <span class="o">=</span> <span class="n">BaseWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                    <span class="n">max_runs_in_buffer</span><span class="o">=</span><span class="n">WORKFLOWS_PROFILER_BUFFER_SIZE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">profiler</span> <span class="o">=</span> <span class="n">NullWorkflowsProfiler</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">process_workflow_inference_request</span><span class="p">(</span>
                <span class="n">workflow_request</span><span class="o">=</span><span class="n">workflow_request</span><span class="p">,</span>
                <span class="n">workflow_specification</span><span class="o">=</span><span class="n">workflow_request</span><span class="o">.</span><span class="n">specification</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">background_tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/execution_engine/versions&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ExecutionEngineVersions</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Returns available Execution Engine versions sorted from oldest to newest&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Returns available Execution Engine versions sorted from oldest to newest&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_execution_engine_versions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ExecutionEngineVersions</span><span class="p">:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="n">get_available_versions</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ExecutionEngineVersions</span><span class="p">(</span><span class="n">versions</span><span class="o">=</span><span class="n">versions</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[LEGACY] Endpoint to get definition of workflows blocks that are accessible&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides detailed information about workflows building blocks that are &quot;</span>
            <span class="s2">&quot;accessible in the inference server. This information could be used to programmatically &quot;</span>
            <span class="s2">&quot;build / display workflows.&quot;</span><span class="p">,</span>
            <span class="n">deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflows_blocks</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">handle_describe_workflows_blocks_request</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/blocks/describe&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to get definition of workflows blocks that are accessible&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides detailed information about workflows building blocks that are &quot;</span>
            <span class="s2">&quot;accessible in the inference server. This information could be used to programmatically &quot;</span>
            <span class="s2">&quot;build / display workflows. Additionally - in request body one can specify list of &quot;</span>
            <span class="s2">&quot;dynamic blocks definitions which will be transformed into blocks and used to generate &quot;</span>
            <span class="s2">&quot;schemas and definitions of connections&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">describe_workflows_blocks</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
            <span class="n">request_payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DescribeBlocksRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowsBlocksDescription</span><span class="p">,</span> <span class="n">Response</span><span class="p">]:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">requested_execution_engine_version</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">request_payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dynamic_blocks_definitions</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request_payload</span><span class="o">.</span><span class="n">dynamic_blocks_definitions</span>
                <span class="p">)</span>
                <span class="n">requested_execution_engine_version</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request_payload</span><span class="o">.</span><span class="n">execution_engine_version</span>
                <span class="p">)</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">api_key</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;api_key&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">handle_describe_workflows_blocks_request</span><span class="p">(</span>
                <span class="n">dynamic_blocks_definitions</span><span class="o">=</span><span class="n">dynamic_blocks_definitions</span><span class="p">,</span>
                <span class="n">requested_execution_engine_version</span><span class="o">=</span><span class="n">requested_execution_engine_version</span><span class="p">,</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/definition/schema&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowsBlocksSchemaDescription</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Endpoint to fetch the workflows block schema&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint to fetch the schema of all available blocks. This information can be &quot;</span>
            <span class="s2">&quot;used to validate workflow definitions and suggest syntax in the JSON editor.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_workflow_schema</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowsBlocksSchemaDescription</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_workflow_schema_description</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">gzip_response_if_requested</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/blocks/dynamic_outputs&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to get definition of dynamic output for workflow step&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint to be used when step outputs can be discovered only after &quot;</span>
            <span class="s2">&quot;filling manifest with data.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_dynamic_block_outputs</span><span class="p">(</span>
            <span class="n">step_manifest</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="c1"># Potentially TODO: dynamic blocks do not support dynamic outputs, but if it changes</span>
            <span class="c1"># we need to provide dynamic blocks manifests here</span>
            <span class="n">dummy_workflow_definition</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">step_manifest</span><span class="p">],</span>
                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>
            <span class="n">available_blocks</span> <span class="o">=</span> <span class="n">load_workflow_blocks</span><span class="p">()</span>
            <span class="n">parsed_definition</span> <span class="o">=</span> <span class="n">parse_workflow_definition</span><span class="p">(</span>
                <span class="n">raw_workflow_definition</span><span class="o">=</span><span class="n">dummy_workflow_definition</span><span class="p">,</span>
                <span class="n">available_blocks</span><span class="o">=</span><span class="n">available_blocks</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parsed_manifest</span> <span class="o">=</span> <span class="n">parsed_definition</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">parsed_manifest</span><span class="o">.</span><span class="n">get_actual_outputs</span><span class="p">()</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/workflows/validate&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">WorkflowValidationStatus</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Endpoint to validate&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint provides a way to check validity of JSON workflow definition.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_workflow</span><span class="p">(</span>
            <span class="n">specification</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowValidationStatus</span><span class="p">:</span>
            <span class="c1"># TODO: get rid of async: https://github.com/roboflow/inference/issues/569</span>
            <span class="n">step_execution_mode</span> <span class="o">=</span> <span class="n">StepExecutionMode</span><span class="p">(</span><span class="n">WORKFLOWS_STEP_EXECUTION_MODE</span><span class="p">)</span>
            <span class="n">workflow_init_parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;workflows_core.model_manager&quot;</span><span class="p">:</span> <span class="n">model_manager</span><span class="p">,</span>
                <span class="s2">&quot;workflows_core.api_key&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;workflows_core.background_tasks&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;workflows_core.step_execution_mode&quot;</span><span class="p">:</span> <span class="n">step_execution_mode</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">workflow_definition</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span>
                <span class="n">init_parameters</span><span class="o">=</span><span class="n">workflow_init_parameters</span><span class="p">,</span>
                <span class="n">max_concurrent_steps</span><span class="o">=</span><span class="n">WORKFLOWS_MAX_CONCURRENT_STEPS</span><span class="p">,</span>
                <span class="n">prevent_local_images_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">WorkflowValidationStatus</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">WEBRTC_WORKER_ENABLED</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/initialise_webrtc_worker&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">InitializeWebRTCResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and processes video stream in spawned process or modal function&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and processes video stream in spawned process or modal function&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise_webrtc_worker</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">WebRTCWorkerRequest</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InitializeWebRTCResponse</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received initialise_webrtc_worker request&quot;</span><span class="p">)</span>
            <span class="n">worker_result</span><span class="p">:</span> <span class="n">WebRTCWorkerResult</span> <span class="o">=</span> <span class="k">await</span> <span class="n">start_worker</span><span class="p">(</span>
                <span class="n">webrtc_request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span> <span class="o">==</span> <span class="s2">&quot;WorkflowSyntaxError&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">WorkflowSyntaxError</span><span class="p">(</span>
                        <span class="n">public_message</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
                        <span class="n">context</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_context</span><span class="p">,</span>
                        <span class="n">inner_error</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">inner_error</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">expected_exceptions</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Exception&quot;</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
                    <span class="s2">&quot;KeyError&quot;</span><span class="p">:</span> <span class="ne">KeyError</span><span class="p">,</span>
                    <span class="s2">&quot;MissingApiKeyError&quot;</span><span class="p">:</span> <span class="n">MissingApiKeyError</span><span class="p">,</span>
                    <span class="s2">&quot;NotImplementedError&quot;</span><span class="p">:</span> <span class="ne">NotImplementedError</span><span class="p">,</span>
                    <span class="s2">&quot;RoboflowAPINotAuthorizedError&quot;</span><span class="p">:</span> <span class="n">RoboflowAPINotAuthorizedError</span><span class="p">,</span>
                    <span class="s2">&quot;RoboflowAPINotNotFoundError&quot;</span><span class="p">:</span> <span class="n">RoboflowAPINotNotFoundError</span><span class="p">,</span>
                    <span class="s2">&quot;ValidationError&quot;</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">expected_exceptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span><span class="p">,</span> <span class="ne">Exception</span>
                <span class="p">)(</span><span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Initialise webrtc worker failed with %s: %s&quot;</span><span class="p">,</span>
                    <span class="n">worker_result</span><span class="o">.</span><span class="n">exception_type</span><span class="p">,</span>
                    <span class="n">worker_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">exc</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning initialise_webrtc_worker response&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitializeWebRTCResponse</span><span class="p">(</span>
                <span class="n">context</span><span class="o">=</span><span class="n">CommandContext</span><span class="p">(),</span>
                <span class="n">status</span><span class="o">=</span><span class="n">OperationStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
                <span class="n">sdp</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">sdp</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">worker_result</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">ENABLE_STREAM_API</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/list&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ListPipelinesResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] List active InferencePipelines&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Listing all active InferencePipelines processing videos&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_pipelines</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ListPipelinesResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">list_pipelines</span><span class="p">()</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/status&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">InferencePipelineStatusResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Get status of InferencePipeline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Get status of InferencePipeline&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_status</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferencePipelineStatusResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/initialise&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Starts new InferencePipeline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Starts new InferencePipeline&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">InitialisePipelinePayload</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">initialise_pipeline</span><span class="p">(</span>
                <span class="n">initialisation_request</span><span class="o">=</span><span class="n">request</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/initialise_webrtc&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">InitializeWebRTCPipelineResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and starts new InferencePipeline consuming video track&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Establishes WebRTC peer connection and starts new InferencePipeline consuming video track&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialise_webrtc_inference_pipeline</span><span class="p">(</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">InitialiseWebRTCPipelinePayload</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received initialise webrtc inference pipeline request&quot;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">initialise_webrtc_pipeline</span><span class="p">(</span>
                <span class="n">initialisation_request</span><span class="o">=</span><span class="n">request</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning initialise webrtc inference pipeline response&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/pause&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Pauses the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Pauses the InferencePipeline&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">pause_pipeline</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/resume&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Resumes the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Resumes the InferencePipeline&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">resume</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">resume_pipeline</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/terminate&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">CommandResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Terminates the InferencePipeline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Terminates the InferencePipeline&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandResponse</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">terminate_pipeline</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span>
            <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/inference_pipelines/</span><span class="si">{pipeline_id}</span><span class="s2">/consume&quot;</span><span class="p">,</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">ConsumePipelineResponse</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Consumes InferencePipeline result&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;[EXPERIMENTAL] Consumes InferencePipeline result&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions_async</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span>
            <span class="n">pipeline_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsumeResultsPayload</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConsumePipelineResponse</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">ConsumeResultsPayload</span><span class="p">()</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_manager_client</span><span class="o">.</span><span class="n">consume_pipeline_result</span><span class="p">(</span>
                <span class="n">pipeline_id</span><span class="o">=</span><span class="n">pipeline_id</span><span class="p">,</span>
                <span class="n">excluded_fields</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">excluded_fields</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Enable preloading models at startup</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PRELOAD_MODELS</span> <span class="ow">or</span> <span class="n">DEDICATED_DEPLOYMENT_WORKSPACE_URL</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">API_KEY</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">)</span>
    <span class="p">):</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">ModelInitState</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Class to track model initialization state.&quot;&quot;&quot;</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># For thread-safe updates</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialization_errors</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track errors per model</span>

        <span class="n">model_init_state</span> <span class="o">=</span> <span class="n">ModelInitState</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">initialize_models</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ModelInitState</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Perform asynchronous initialization tasks to load models.&quot;&quot;&quot;</span>
            <span class="c1"># Limit the number of concurrent tasks to prevent resource exhaustion</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_model(</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">) - starting&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># TODO: how to add timeout here? Probably best to timeout model loading?</span>
                    <span class="n">model_add</span><span class="p">(</span>
                        <span class="n">AddModelRequest</span><span class="p">(</span>
                            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                            <span class="n">model_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> loaded successfully.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error loading model </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">initialization_errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_model(</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">) - finished&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">PRELOAD_MODELS</span><span class="p">:</span>
                <span class="c1"># Create tasks for each model to be loaded</span>
                <span class="n">model_loading_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">loaded_futures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Future</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">PRELOAD_MODELS</span><span class="p">:</span>
                    <span class="n">future</span> <span class="o">=</span> <span class="n">model_loading_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="n">load_model</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span>
                    <span class="p">)</span>
                    <span class="n">loaded_futures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model_id</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">loaded_futures</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span>
                        <span class="ne">TimeoutError</span><span class="p">,</span>
                        <span class="n">CancelledError</span><span class="p">,</span>
                        <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
                    <span class="p">):</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">initialization_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">model_id</span><span class="p">,</span>
                                <span class="s2">&quot;Could not finalise model loading before timeout&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="c1"># Update the readiness state in a thread-safe manner</span>
            <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="n">state</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">startup_model_init</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Initialize the models on startup.&quot;&quot;&quot;</span>
            <span class="n">startup_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">initialize_models</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model_init_state</span><span class="p">,),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">startup_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model initialization started in the background.&quot;</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/readiness&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">readiness</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">ModelInitState</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">model_init_state</span><span class="p">),</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Readiness endpoint for Kubernetes readiness probe.&quot;&quot;&quot;</span>
            <span class="k">with</span> <span class="n">state</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_ready</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ready&quot;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not ready&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">503</span>
                    <span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/healthz&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">healthz</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Health endpoint for Kubernetes liveness probe.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">CORE_MODELS_ENABLED</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CORE_MODEL_CLIP_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/clip/embed_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ClipEmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Image Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to embed image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">clip_embed_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipImageEmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the OpenAI CLIP model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ClipImageEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ClipEmbeddingResponse: The response containing the embedded image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/embed_image&quot;</span><span class="p">)</span>
                <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/clip/embed_text&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ClipEmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Text Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to embed text data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">clip_embed_text</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipTextEmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds text data using the OpenAI CLIP model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ClipTextEmbeddingRequest): The request containing the text to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ClipEmbeddingResponse: The response containing the embedded text.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/embed_text&quot;</span><span class="p">)</span>
                <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/clip/compare&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ClipCompareResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;CLIP Compare&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Open AI CLIP model to compute similarity scores.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">clip_compare</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">ClipCompareRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Computes similarity scores using the OpenAI CLIP model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (ClipCompareRequest): The request containing the data to be compared.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ClipCompareResponse: The response containing the similarity scores.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clip/compare&quot;</span><span class="p">)</span>
                <span class="n">clip_model_id</span> <span class="o">=</span> <span class="n">load_clip_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">clip_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">clip_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_PE_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/perception_encoder/embed_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderEmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;PE Image Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to embed image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">pe_embed_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderImageEmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the Perception Encoder PE model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (PerceptionEncoderImageEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    PerceptionEncoderEmbeddingResponse: The response containing the embedded image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/embed_image&quot;</span><span class="p">)</span>
                <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/perception_encoder/embed_text&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderEmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Perception Encoder Text Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to embed text data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">pe_embed_text</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderTextEmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds text data using the Meta Perception Encoder model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (PerceptionEncoderTextEmbeddingRequest): The request containing the text to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    PerceptionEncoderEmbeddingResponse: The response containing the embedded text.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/embed_text&quot;</span><span class="p">)</span>
                <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/perception_encoder/compare&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">PerceptionEncoderCompareResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Perception Encoder Compare&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta Perception Encoder model to compute similarity scores.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">pe_compare</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">PerceptionEncoderCompareRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Computes similarity scores using the Meta Perception Encoder model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (PerceptionEncoderCompareRequest): The request containing the data to be compared.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    PerceptionEncoderCompareResponse: The response containing the similarity scores.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /perception_encoder/compare&quot;</span><span class="p">)</span>
                <span class="n">pe_model_id</span> <span class="o">=</span> <span class="n">load_pe_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">pe_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">pe_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_GROUNDINGDINO_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/grounding_dino/infer&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Grounding DINO inference.&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Grounding DINO zero-shot object detection model.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">grounding_dino_infer</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">GroundingDINOInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the Grounding DINO model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request GroundingDINOInferenceRequest): The request containing the image on which to run object detection.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ObjectDetectionInferenceResponse: The object detection response.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /grounding_dino/infer&quot;</span><span class="p">)</span>
                <span class="n">grounding_dino_model_id</span> <span class="o">=</span> <span class="n">load_grounding_dino_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">grounding_dino_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">grounding_dino_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_YOLO_WORLD_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/yolo_world/infer&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;YOLO-World inference.&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the YOLO-World zero-shot object detection model.&quot;</span><span class="p">,</span>
                <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">yolo_world_infer</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">YOLOWorldInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Runs the YOLO-World zero-shot object detection model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (YOLOWorldInferenceRequest): The request containing the image on which to run object detection.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    ObjectDetectionInferenceResponse: The object detection response.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /yolo_world/infer. Loading model&quot;</span><span class="p">)</span>
                <span class="n">yolo_world_model_id</span> <span class="o">=</span> <span class="n">load_yolo_world_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;YOLOWorld model loaded. Staring the inference.&quot;</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">yolo_world_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;YOLOWorld prediction available.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">yolo_world_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Usage of YOLOWorld denoted.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_DOCTR_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/doctr/ocr&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">OCRInferenceResponse</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OCRInferenceResponse</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;DocTR OCR response&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the DocTR OCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">doctr_retrieve_text</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">DoctrOCRInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the DocTR model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (M.DoctrOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    OCRInferenceResponse: The response containing the embedded image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /doctr/ocr&quot;</span><span class="p">)</span>
                <span class="n">doctr_model_id</span> <span class="o">=</span> <span class="n">load_doctr_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">doctr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">doctr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_EASYOCR_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/easy_ocr/ocr&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">OCRInferenceResponse</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OCRInferenceResponse</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;EasyOCR OCR response&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the EasyOCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">easy_ocr_retrieve_text</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">EasyOCRInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the EasyOCR model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (EasyOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    OCRInferenceResponse: The response containing the embedded image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /easy_ocr/ocr&quot;</span><span class="p">)</span>
                <span class="n">easy_ocr_model_id</span> <span class="o">=</span> <span class="n">load_easy_ocr_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">easy_ocr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">easy_ocr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_SAM_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/sam/embed_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">SamEmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM Image Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segmant Anything Model to embed image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">sam_embed_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">SamEmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.SamEmbeddingResponse or Response: The response containing the embedded image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam/embed_image&quot;</span><span class="p">)</span>
                <span class="n">sam_model_id</span> <span class="o">=</span> <span class="n">load_sam_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">sam_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">sam_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">model_response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/sam/segment_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">SamSegmentationResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM Image Segmentation&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segmant Anything Model to generate segmenations for image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">sam_segment_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">SamSegmentationRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Generates segmentations for image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (SamSegmentationRequest): The request containing the image to be segmented.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.SamSegmentationResponse or Response: The response containing the segmented image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam/segment_image&quot;</span><span class="p">)</span>
                <span class="n">sam_model_id</span> <span class="o">=</span> <span class="n">load_sam_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">sam_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">sam_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">model_response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_SAM2_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/sam2/embed_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Sam2EmbeddingResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM2 Image Embeddings&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segment Anything 2 Model to embed image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">sam2_embed_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">Sam2EmbeddingRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the Meta AI Segment Anything Model (SAM).</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.Sam2EmbeddingResponse or Response: The response affirming the image has been embedded</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam2/embed_image&quot;</span><span class="p">)</span>
                <span class="n">sam2_model_id</span> <span class="o">=</span> <span class="n">load_sam2_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">sam2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">model_response</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/sam2/segment_image&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">Sam2SegmentationResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;SAM2 Image Segmentation&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the Meta AI Segment Anything 2 Model to generate segmenations for image data.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">sam2_segment_image</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">Sam2SegmentationRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Generates segmentations for image data using the Meta AI Segment Anything Model (SAM).</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (Sam2SegmentationRequest): The request containing the image to be segmented.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.SamSegmentationResponse or Response: The response containing the segmented image.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /sam2/segment_image&quot;</span><span class="p">)</span>
                <span class="n">sam2_model_id</span> <span class="o">=</span> <span class="n">load_sam2_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">sam2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">model_response</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">model_response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_OWLV2_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/owlv2/infer&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Owlv2 image prompting&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the google owlv2 model to few-shot object detect&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">owlv2_infer</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">OwlV2InferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Embeds image data using the Meta AI Segmant Anything Model (SAM).</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (SamEmbeddingRequest): The request containing the image to be embedded.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.Sam2EmbeddingResponse or Response: The response affirming the image has been embedded</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /owlv2/infer&quot;</span><span class="p">)</span>
                <span class="n">owl2_model_id</span> <span class="o">=</span> <span class="n">load_owlv2_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">owl2_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">model_response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_GAZE_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/gaze/gaze_detection&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">GazeDetectionInferenceResponse</span><span class="p">],</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Gaze Detection&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the gaze detection model to detect gaze.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">gaze_detection</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">GazeDetectionInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Detect gaze using the gaze detection model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (M.GazeDetectionRequest): The request containing the image to be detected.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    M.GazeDetectionResponse: The response containing all the detected faces and the corresponding gazes.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /gaze/gaze_detection&quot;</span><span class="p">)</span>
                <span class="n">gaze_model_id</span> <span class="o">=</span> <span class="n">load_gaze_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">gaze_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">gaze_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">DEPTH_ESTIMATION_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/infer/depth-estimation&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">DepthEstimationResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Depth Estimation&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the depth estimation model to generate a depth map.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">depth_estimation</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">DepthEstimationRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Generate a depth map using the depth estimation model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (DepthEstimationRequest): The request containing the image to estimate depth for.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    DepthEstimationResponse: The response containing the normalized depth map and optional visualization.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /infer/depth-estimation&quot;</span><span class="p">)</span>
                <span class="n">depth_model_id</span> <span class="o">=</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                    <span class="n">depth_model_id</span><span class="p">,</span>
                    <span class="n">inference_request</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">depth_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">depth_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>

                <span class="c1"># Extract data from nested response structure</span>
                <span class="n">depth_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">response</span>
                <span class="n">depth_response</span> <span class="o">=</span> <span class="n">DepthEstimationResponse</span><span class="p">(</span>
                    <span class="n">normalized_depth</span><span class="o">=</span><span class="n">depth_data</span><span class="p">[</span><span class="s2">&quot;normalized_depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">depth_data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy_image</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">depth_response</span>

        <span class="k">if</span> <span class="n">CORE_MODEL_TROCR_ENABLED</span><span class="p">:</span>

            <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;/ocr/trocr&quot;</span><span class="p">,</span>
                <span class="n">response_model</span><span class="o">=</span><span class="n">OCRInferenceResponse</span><span class="p">,</span>
                <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;TrOCR OCR response&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the TrOCR model to retrieve text in an image.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nd">@with_route_exceptions</span>
            <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">trocr_retrieve_text</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="p">:</span> <span class="n">TrOCRInferenceRequest</span><span class="p">,</span>
                <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Retrieves text from image data using the TrOCR model.</span>

<span class="sd">                Args:</span>
<span class="sd">                    inference_request (TrOCRInferenceRequest): The request containing the image from which to retrieve text.</span>
<span class="sd">                    api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                    request (Request, default Body()): The HTTP request.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    OCRInferenceResponse: The response containing the retrieved text.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /trocr/ocr&quot;</span><span class="p">)</span>
                <span class="n">trocr_model_id</span> <span class="o">=</span> <span class="n">load_trocr_model</span><span class="p">(</span>
                    <span class="n">inference_request</span><span class="p">,</span>
                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                    <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                    <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                    <span class="n">trocr_model_id</span><span class="p">,</span> <span class="n">inference_request</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                    <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;authorizer&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">trocr_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">orjson_response_keeping_parent_id</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/notebook/start&quot;</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Jupyter Lab Server Start&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Starts a jupyter lab server for running development code&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">notebook_start</span><span class="p">(</span><span class="n">browserless</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Starts a jupyter lab server for running development code.</span>

<span class="sd">            Args:</span>
<span class="sd">                inference_request (NotebookStartRequest): The request containing the necessary details for starting a jupyter lab server.</span>
<span class="sd">                background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>

<span class="sd">            Returns:</span>
<span class="sd">                NotebookStartResponse: The response containing the URL of the jupyter lab server.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /notebook/start&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">NOTEBOOK_ENABLED</span><span class="p">:</span>
                <span class="n">start_notebook</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">browserless</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Jupyter Lab server started at http://localhost:</span><span class="si">{</span><span class="n">NOTEBOOK_PORT</span><span class="si">}</span><span class="s2">?token=</span><span class="si">{</span><span class="n">NOTEBOOK_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;http://localhost:</span><span class="si">{</span><span class="n">NOTEBOOK_PORT</span><span class="si">}</span><span class="s2">/lab/tree/quickstart.ipynb?token=</span><span class="si">{</span><span class="n">NOTEBOOK_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">browserless</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Notebook server is not enabled. Enable notebooks via the NOTEBOOK_ENABLED environment variable.&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/notebook-instructions.html&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ENABLE_BUILDER</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">inference.core.interfaces.http.builder.routes</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">router</span> <span class="k">as</span> <span class="n">builder_router</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Allow CORS on only the API, but not the builder UI/iframe (where the CSRF is passed)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
            <span class="n">PathAwareCORSMiddleware</span><span class="p">,</span>
            <span class="n">match_paths</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^/build/api.*&quot;</span><span class="p">,</span>
            <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="n">BUILDER_ORIGIN</span><span class="p">],</span>
            <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Attach all routes from builder to the /build prefix</span>
        <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">builder_router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/build&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;builder&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">LEGACY_ROUTE_ENABLED</span><span class="p">:</span>
        <span class="c1"># Legacy object detection inference path for backwards compatibility</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;/</span><span class="si">{dataset_id}</span><span class="s2">/{version_id:str}&quot;</span><span class="p">,</span>
            <span class="c1"># Order matters in this response model Union. It will use the first matching model. For example, Object Detection Inference Response is a subset of Instance segmentation inference response, so instance segmentation must come first in order for the matching logic to work.</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span>
                <span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">StubResponse</span><span class="p">,</span>
                <span class="n">Any</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s2">&quot;/</span><span class="si">{dataset_id}</span><span class="s2">/{version_id:str}&quot;</span><span class="p">,</span>
            <span class="c1"># Order matters in this response model Union. It will use the first matching model. For example, Object Detection Inference Response is a subset of Instance segmentation inference response, so instance segmentation must come first in order for the matching logic to work.</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span>
                <span class="n">InstanceSegmentationInferenceResponse</span><span class="p">,</span>
                <span class="n">KeypointsDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">ObjectDetectionInferenceResponse</span><span class="p">,</span>
                <span class="n">ClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">MultiLabelClassificationInferenceResponse</span><span class="p">,</span>
                <span class="n">StubResponse</span><span class="p">,</span>
                <span class="n">Any</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">response_model_exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nd">@with_route_exceptions</span>
        <span class="nd">@usage_collector</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">legacy_infer_from_request</span><span class="p">(</span>
            <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
            <span class="n">request_body</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
                <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">UploadFile</span><span class="p">]],</span>
                <span class="n">Depends</span><span class="p">(</span><span class="n">parse_body_content_for_legacy_request_handler</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ID of a Roboflow dataset corresponding to the model to use for inference OR workspace ID&quot;</span>
            <span class="p">),</span>
            <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ID of a Roboflow dataset version corresponding to the model to use for inference OR model ID&quot;</span>
            <span class="p">),</span>
            <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Roboflow API Key that will be passed to the model during initialization for artifact retrieval&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mf">0.4</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The confidence threshold used to filter out predictions&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">keypoint_confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The confidence threshold used to filter out keypoints that are not visible based on model confidence&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="s2">&quot;json&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of &#39;json&#39; or &#39;image&#39;. If &#39;json&#39; prediction data is return as a JSON string. If &#39;image&#39; prediction data is visualized and overlayed on the original input image.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The publically accessible URL of an image to use for inference.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">image_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="s2">&quot;base64&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of base64 or numpy. Note, numpy input is not supported for Roboflow Hosted Inference.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, labels will be include in any inference visualization.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">mask_decode_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="s2">&quot;accurate&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;One of &#39;accurate&#39; or &#39;fast&#39;. If &#39;accurate&#39; the mask will be decoded using the original image size. If &#39;fast&#39; the mask will be decoded using the original mask size. &#39;accurate&#39; is slower but more accurate.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">tradeoff_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The amount to tradeoff between 0=&#39;fast&#39; and 1=&#39;accurate&#39;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">max_detections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mi">300</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The maximum number of detections to return. This is used to limit the number of predictions returned by the model. The model may return more predictions than this number, but only the top `max_detections` predictions will be returned.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mf">0.3</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The IoU threhsold that must be met for a box pair to be considered duplicate during NMS&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">stroke</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The stroke width used when visualizing predictions&quot;</span>
            <span class="p">),</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If false, does not track inference against usage.&quot;</span><span class="p">,</span>
                <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Shared secret used to authenticate requests to the inference server from internal services (e.g. to allow disabling inference usage tracking via the `countinference` query parameter)&quot;</span><span class="p">,</span>
                <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">disable_preproc_auto_orient</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic image orientation&quot;</span>
            <span class="p">),</span>
            <span class="n">disable_preproc_contrast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic contrast adjustment&quot;</span>
            <span class="p">),</span>
            <span class="n">disable_preproc_grayscale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic grayscale conversion&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">disable_preproc_static_crop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables automatic static crop&quot;</span>
            <span class="p">),</span>
            <span class="n">disable_active_learning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, the predictions will be prevented from registration by Active Learning (if the functionality is enabled)&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">active_learning_target_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parameter to be used when Active Learning data registration should happen against different dataset than the one pointed by model_id&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="s2">&quot;external&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The source of the inference request&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">source_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="s2">&quot;external&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The detailed source information of the inference request&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">disable_model_monitoring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If true, disables model monitoring for this request&quot;</span><span class="p">,</span>
                <span class="n">include_in_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Legacy inference endpoint for object detection, instance segmentation, and classification.</span>

<span class="sd">            Args:</span>
<span class="sd">                background_tasks: (BackgroundTasks) pool of fastapi background tasks</span>
<span class="sd">                dataset_id (str): ID of a Roboflow dataset corresponding to the model to use for inference OR workspace ID</span>
<span class="sd">                version_id (str): ID of a Roboflow dataset version corresponding to the model to use for inference OR model ID</span>
<span class="sd">                api_key (Optional[str], default None): Roboflow API Key passed to the model during initialization for artifact retrieval.</span>
<span class="sd">                # Other parameters described in the function signature...</span>

<span class="sd">            Returns:</span>
<span class="sd">                Union[InstanceSegmentationInferenceResponse, KeypointsDetectionInferenceRequest, ObjectDetectionInferenceResponse, ClassificationInferenceResponse, MultiLabelClassificationInferenceResponse, Any]: The response containing the inference results.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reached legacy route /:dataset_id/:version_id with </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">confidence</span> <span class="o">/=</span> <span class="mi">100</span>
            <span class="k">elif</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">CONFIDENCE_LOWER_BOUND_OOM_PREVENTION</span><span class="p">:</span>
                <span class="c1"># allowing lower confidence results in RAM usage explosion</span>
                <span class="n">confidence</span> <span class="o">=</span> <span class="n">CONFIDENCE_LOWER_BOUND_OOM_PREVENTION</span>

            <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">overlap</span> <span class="o">/=</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ContentTypeMissing</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Request must include a Content-Type header&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="n">UploadFile</span><span class="p">):</span>
                    <span class="n">base64_image_str</span> <span class="o">=</span> <span class="n">request_body</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">base64_image_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">base64_image_str</span><span class="p">)</span>
                    <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;base64&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">base64_image_str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request_body</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">request_image</span> <span class="o">=</span> <span class="n">InferenceRequestImage</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">image_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">request_body</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">request_body</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputImageLoadError</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Image not found in request body.&quot;</span><span class="p">,</span>
                        <span class="n">public_message</span><span class="o">=</span><span class="s2">&quot;Image not found in request body.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ContentTypeInvalid</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid Content-Type: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">countinference</span> <span class="ow">and</span> <span class="n">service_secret</span> <span class="o">!=</span> <span class="n">ROBOFLOW_SERVICE_SECRET</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingServiceSecretError</span><span class="p">(</span>
                    <span class="s2">&quot;Service secret is required to disable inference usage tracking&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">LAMBDA</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request.scope: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
                <span class="n">request_model_id</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span><span class="s2">&quot;authorizer&quot;</span><span class="p">][</span>
                        <span class="s2">&quot;lambda&quot;</span>
                    <span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;endpoint&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rf-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;nu-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">actor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="s2">&quot;aws.event&quot;</span><span class="p">][</span><span class="s2">&quot;requestContext&quot;</span><span class="p">][</span><span class="s2">&quot;authorizer&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;lambda&quot;</span>
                <span class="p">][</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">countinference</span><span class="p">:</span>
                    <span class="n">trackUsage</span><span class="p">(</span><span class="n">request_model_id</span><span class="p">,</span> <span class="n">actor</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">service_secret</span> <span class="o">!=</span> <span class="n">ROBOFLOW_SERVICE_SECRET</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MissingServiceSecretError</span><span class="p">(</span>
                            <span class="s2">&quot;Service secret is required to disable inference usage tracking&quot;</span>
                        <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not counting inference for usage&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">request_model_id</span> <span class="o">=</span> <span class="n">model_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;State of model registry: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">describe_models</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                <span class="n">request_model_id</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">,</span>
                <span class="n">model_id_alias</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">get_task_type</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
            <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">ObjectDetectionInferenceRequest</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;instance-segmentation&quot;</span><span class="p">:</span>
                <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">InstanceSegmentationInferenceRequest</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;mask_decode_mode&quot;</span><span class="p">:</span> <span class="n">mask_decode_mode</span><span class="p">,</span>
                    <span class="s2">&quot;tradeoff_factor&quot;</span><span class="p">:</span> <span class="n">tradeoff_factor</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;classification&quot;</span><span class="p">:</span>
                <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">ClassificationInferenceRequest</span>
            <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s2">&quot;keypoint-detection&quot;</span><span class="p">:</span>
                <span class="n">inference_request_type</span> <span class="o">=</span> <span class="n">KeypointsDetectionInferenceRequest</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keypoint_confidence&quot;</span><span class="p">:</span> <span class="n">keypoint_confidence</span><span class="p">}</span>
            <span class="n">inference_request</span> <span class="o">=</span> <span class="n">inference_request_type</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">image</span><span class="o">=</span><span class="n">request_image</span><span class="p">,</span>
                <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
                <span class="n">iou_threshold</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                <span class="n">max_detections</span><span class="o">=</span><span class="n">max_detections</span><span class="p">,</span>
                <span class="n">visualization_labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">visualization_stroke_width</span><span class="o">=</span><span class="n">stroke</span><span class="p">,</span>
                <span class="n">visualize_predictions</span><span class="o">=</span><span class="p">(</span>
                    <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">or</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image_and_json&quot;</span>
                <span class="p">),</span>
                <span class="n">disable_preproc_auto_orient</span><span class="o">=</span><span class="n">disable_preproc_auto_orient</span><span class="p">,</span>
                <span class="n">disable_preproc_contrast</span><span class="o">=</span><span class="n">disable_preproc_contrast</span><span class="p">,</span>
                <span class="n">disable_preproc_grayscale</span><span class="o">=</span><span class="n">disable_preproc_grayscale</span><span class="p">,</span>
                <span class="n">disable_preproc_static_crop</span><span class="o">=</span><span class="n">disable_preproc_static_crop</span><span class="p">,</span>
                <span class="n">disable_active_learning</span><span class="o">=</span><span class="n">disable_active_learning</span><span class="p">,</span>
                <span class="n">active_learning_target_dataset</span><span class="o">=</span><span class="n">active_learning_target_dataset</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="n">source_info</span><span class="o">=</span><span class="n">source_info</span><span class="p">,</span>
                <span class="n">usage_billable</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">disable_model_monitoring</span><span class="o">=</span><span class="n">disable_model_monitoring</span><span class="p">,</span>
                <span class="o">**</span><span class="n">args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">inference_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">infer_from_request_sync</span><span class="p">(</span>
                <span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">inference_request</span><span class="p">,</span>
                <span class="n">active_learning_eligible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">background_tasks</span><span class="o">=</span><span class="n">background_tasks</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response ready.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">inference_response</span><span class="o">.</span><span class="n">visualization</span><span class="p">,</span>
                    <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">orjson_response</span><span class="p">(</span><span class="n">inference_response</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">LAMBDA</span> <span class="ow">or</span> <span class="n">GCP_SERVERLESS</span><span class="p">):</span>
        <span class="c1"># Legacy clear cache endpoint for backwards compatibility</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/clear_cache&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">legacy_clear_cache</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Clears the model cache.</span>

<span class="sd">            This endpoint provides a way to clear the cache of loaded models.</span>

<span class="sd">            Returns:</span>
<span class="sd">                str: A string indicating that the cache has been cleared.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached /clear_cache&quot;</span><span class="p">)</span>
            <span class="n">model_clear</span><span class="p">()</span>
            <span class="k">return</span> <span class="s2">&quot;Cache Cleared&quot;</span>

        <span class="c1"># Legacy add model endpoint for backwards compatibility</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/start/</span><span class="si">{dataset_id}</span><span class="s2">/</span><span class="si">{version_id}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">model_add_legacy</span><span class="p">(</span>
            <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">countinference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Starts a model inference session.</span>

<span class="sd">            This endpoint initializes and starts an inference session for the specified model version.</span>

<span class="sd">            Args:</span>
<span class="sd">                dataset_id (str): ID of a Roboflow dataset corresponding to the model.</span>
<span class="sd">                version_id (str): ID of a Roboflow dataset version corresponding to the model.</span>
<span class="sd">                api_key (str, optional): Roboflow API Key for artifact retrieval.</span>
<span class="sd">                countinference (Optional[bool]): Whether to count inference or not.</span>
<span class="sd">                service_secret (Optional[str]): The service secret for the request.</span>

<span class="sd">            Returns:</span>
<span class="sd">                JSONResponse: A response object containing the status and a success message.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reached /start/</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_manager</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span>
                <span class="n">model_id</span><span class="p">,</span>
                <span class="n">api_key</span><span class="p">,</span>
                <span class="n">countinference</span><span class="o">=</span><span class="n">countinference</span><span class="p">,</span>
                <span class="n">service_secret</span><span class="o">=</span><span class="n">service_secret</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;inference session started from local memory.&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ENABLE_DASHBOARD</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/dashboard.html&quot;</span><span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="s2">&quot;/dashboard.html&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dashboard_guard</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">InputImageLoadError</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unicorn_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">InputImageLoadError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Could not load input image. Cause: </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="n">get_public_error_details</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
        <span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./inference/landing/out&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="inference.core.interfaces.http.http_api.load_gaze_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_gaze_model</span><span class="p">(</span><span class="n">inference_request</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#inference.core.interfaces.http.http_api.load_gaze_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Loads the gaze detection model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inference_request</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" href="../../../entities/requests/gaze/#inference.core.entities.requests.gaze.GazeDetectionInferenceRequest">GazeDetectionInferenceRequest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The inference request.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api_key</code>
            </td>
            <td>
                  <code>Optional[str], default None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Roboflow API key.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model ID.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>inference/core/interfaces/http/http_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_gaze_model</span><span class="p">(</span>
    <span class="n">inference_request</span><span class="p">:</span> <span class="n">GazeDetectionInferenceRequest</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the gaze detection model.</span>

<span class="sd">    Args:</span>
<span class="sd">        inference_request (GazeDetectionInferenceRequest): The inference request.</span>
<span class="sd">        api_key (Optional[str], default None): The Roboflow API key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The model ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">inference_request</span><span class="o">.</span><span class="n">model_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>









  




                
              </article>
            </div>
          
  

          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../error_handlers/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Error handlers">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Error handlers
              </div>
            </div>
          </a>
        
        
          
          <a href="../builder/routes/" class="md-footer__link md-footer__link--next" aria-label="Next: Routes">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Routes
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Roboflow 2025. All rights reserved.
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/roboflow" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/roboflow" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/roboflow-ai/mycompany/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/roboflow" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../../..", "features": ["announce.dismiss", "content.action.edit", "content.code.copy", "content.tabs.link", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.preview", "navigation.instant.progress", "navigation.prune", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "optimize", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../../assets/javascripts/workers/search.c7c1ca2c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": 1.0}}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.5a789024.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
      
        <script src="../../../../../../javascript/init_kapa_widget.js"></script>
      
        <script src="../../../../../../javascript/cookbooks.js"></script>
      
        <script src="../../../../../../javascript/workflows.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
      
        <script src="https://unpkg.com/@rive-app/canvas"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
      
        <script src="../../../../../../assets/home.js"></script>
      
        <script src="../../../../../../js/segment.js"></script>
      
    
  </body>
</html>